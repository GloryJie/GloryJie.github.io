[{"content":" å°é¢ä¸ºã€Šä¸è‰¯äººã€‹ç¬¬å…­å­£ä¸­çš„å°¸ç¥–é™è‡£\nESå¸¸è§çš„åº”ç”¨åœºæ™¯å°±æ˜¯æœç´¢ï¼Œå¤§å¤šæ•°ä¸šåŠ¡ç³»ç»Ÿçš„æ•°æ®è¿ç§»åˆ°ESåï¼Œå¤§éƒ½æ˜¯ç­‰å€¼ã€èŒƒå›´ã€likeç­‰ï¼Œå¹¶æœªä½¿ç”¨åˆ°matchæŸ¥è¯¢ï¼Œç›¸å½“äºæŠŠESæœç´¢å½“åšMySQLæ¥ä½¿ç”¨ã€‚æœ¬æ–‡ä¸ä¼šæ¶‰åŠåˆ°åˆ†è¯ã€æœç´¢æ‰“åˆ†ç­‰åœºæ™¯ï¼Œæ›´å€¾å‘äºå¸¸ç”¨æ•°æ®çš„æœç´¢ã€‚\nä¸šåŠ¡æœåŠ¡å’ŒESçš„äº¤äº’æ–¹å¼ å¦‚ä½•ä½¿ç”¨ESï¼Œä¼šå½±å“åˆ°Mappingçš„è®¾è®¡åŸåˆ™ã€‚åœ¨å®è·µè¿‡ç¨‹ä¸­ï¼Œä»…ä»…æ˜¯æŠŠESå½“åšIDçš„ç­›é€‰å™¨ã€‚\nåœ¨æ•°æ®åŒæ­¥é˜¶æ®µï¼ŒåªæŠŠéœ€è¦æœç´¢çš„å­—æ®µåŒæ­¥åˆ°esä¸­ï¼Œé™ä½å•ä¸ªæ–‡æ¡£çš„å¤§å° æœç´¢é˜¶æ®µï¼Œé€šè¿‡esè¿›è¡Œæœç´¢ï¼ŒæŸ¥è¯¢å‡ºidçš„é›†åˆï¼Œä¹‹åé€šè¿‡è¯¥idé›†åˆä»MySQLä¸­è·å–åŸå§‹çš„æ•°æ®æº æµç¨‹çš„ç¤ºæ„å›¾å¦‚ä¸‹\nESçš„æœç´¢æµç¨‹ä¸­ï¼Œæœ‰ä¸¤ä¸ªé˜¶æ®µï¼šsearchã€fetchã€‚\nsearché˜¶æ®µæ˜¯ä»åˆ†ç‰‡ä¸­æœç´¢å¹¶è·å–ç›¸åº”æ–‡æ¡£idå’Œå…¶æ’åºæ•°æ®ï¼Œåœ¨åè°ƒèŠ‚ç‚¹å¤„ç†ï¼Œç”Ÿæˆç»“æœé›†id fetché˜¶æ®µæ˜¯å°†å¯¹åº”çš„ç»“æœé›†idï¼Œä»idå¯¹åº”åˆ†ç‰‡ä¸­è·å–å®é™…çš„æ–‡æ¡£æ•°æ® ä»ä¸Šè¿°æµç¨‹ä¸­ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œåªä½¿ç”¨åˆ°äº†searché˜¶æ®µï¼Œè€Œfetché˜¶æ®µæ›¿æ¢æˆä¸šåŠ¡æœåŠ¡è‡ªè¡Œè·å–ã€‚\nè¿™ä¸ªæ–¹æ¡ˆçš„ä¼˜ç‚¹å°±æ˜¯æ•°æ®å®æ—¶æ€§é«˜ï¼Œå¯ä»¥è§„é¿ESæ•°æ®æ»åé—®é¢˜ã€‚\næ’åºé—®é¢˜ æ ¹æ®idæ‰¹é‡ä»MySQLä¸­è·å–æ•°æ®ï¼Œè¿”å›çš„é¡ºåºä¼šé”™ä¹±ï¼Œæ‰€ä»¥éœ€è¦æ ¹æ®åŸidçš„é¡ºåºè¿›è¡Œè°ƒæ•´å³å¯ã€‚\nmappingè®¾è®¡ mappingè®¾è®¡å¥½ï¼Œå¯ä»¥å‡å°‘ä¸å¿…è¦çš„è®¡ç®—å’Œå†™å…¥ï¼Œé™ä½ç´¢å¼•å¤§å°ã€‚\nç¦ç”¨Dynamic Mapping åŠ¨æ€æ˜ å°„åœ¨åˆ›å»ºç´¢å¼•æ—¶æœ‰ä¸‰ç§é…ç½®å€¼ï¼Œè‡³å°‘è®¾ç½®ä¸ºfalseã€‚\nå¯é€‰å€¼ å«ä¹‰ true è‡ªåŠ¨æ·»åŠ åˆ°mappingä¸­ï¼Œå¹¶ä¸”æ”¯æŒç´¢å¼•å’Œæœç´¢ runtime æ–°å­—æ®µå°†ä¼šè¢«ä½œä¸ºruntimeç±»å‹çš„filed false ä¸ä¼šæ·»åŠ åˆ°mappingä¸­ï¼Œä¸æ”¯æŒç´¢å¼•å’Œæœç´¢ã€‚ä¸è¿‡ä»ç„¶ä¼šä¿å­˜åœ¨_sourceä¸­ã€‚ strict å¦‚æœå‘ç°æ–°çš„fieldï¼Œä¼šæŠ›å‡ºå¼‚å¸¸ å¿…é¡»æ˜ç¡®æ¯ä¸ªå­—æ®µçš„æ•°æ®ç±»å‹ï¼Œå’Œå…¶å¯¹åº”çš„å±æ€§é…ç½®ï¼Œå°±ç±»ä¼¼äºSQLçš„å»ºè¡¨ï¼Œä¸¥æ ¼ç¡®å®šç»“æ„ã€‚å¯¹äºå­—æ®µæ•°æ®ç±»å‹å’Œå…¶æ”¯æŒçš„å±æ€§é…ç½®ï¼Œéœ€è¦å¯¹ESæœ‰ä¸€å®šçš„ç†Ÿæ‚‰ç¨‹åº¦ï¼Œå¯ä»¥å‚è€ƒesçš„æ–‡æ¡£æ¥è¿›è¡Œè®¾ç½®ï¼Œä¸€èˆ¬æ¥è¯´æ˜ç¡®æ•°æ®ç±»å‹å³å¯ã€‚\né€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ æ˜ç¡®æ•°æ®ç±»å‹çš„æ—¶å€™ï¼Œéœ€è¦é€‰æ‹©åˆé€‚çš„æ•°æ®ç±»å‹ï¼Œä¾‹å¦‚å­—ç¬¦ä¸²ç±»å‹çš„idã€çŠ¶æ€æšä¸¾ç­‰æ˜ç¡®çš„å€¼ï¼Œé€‰æ‹©keywordè€Œä¸æ˜¯textã€‚\nå­—æ®µå°½é‡å°‘ å­—æ®µå°½å¯èƒ½å°‘ï¼Œæœ€å¥½åšåˆ°åªä¿ç•™éœ€è¦å‚ä¸æ£€ç´¢çš„å­—æ®µã€‚å› ä¸ºeséœ€è¦æå‰æ„å»ºå€’æ’ç´¢å¼•ï¼Œæ‰€ä»¥å­—æ®µè¶Šå¤šï¼Œå†™å…¥çš„æ—¶å€™å ç”¨çš„èµ„æºå°±è¶Šå¤šï¼Œç›¸åŒçš„ index buffer èƒ½å­˜å‚¨çš„æ•°æ®æ¡æ•°è¶Šå°‘ã€‚\nè¿™ä¹Ÿå’Œå¯¹ESçš„åº”ç”¨æ–¹å¼æœ‰å…³ï¼Œåœ¨å®è·µä¸­ï¼Œå…ˆåˆ©ç”¨ESæ£€ç´¢å‡ºæ–‡æ¡£idï¼Œä¹‹åæ ¹æ®idä»åŸå§‹æ•°æ®æºMySQLä¸­è·å–æ–‡æ¡£æ•°æ®ã€‚\nä¸éœ€è¦çš„æœç´¢çš„å­—æ®µä¸è¦ç´¢å¼• ä¸éœ€è¦æœç´¢çš„å­—æ®µï¼Œå¦‚æœè¿˜æ˜¯éœ€è¦åŒæ­¥åˆ°esä¸­ï¼Œé‚£ä¹ˆå¯ä»¥å°†å…¶æŒ‡å®šä¸ºéæœç´¢å­—æ®µã€‚å°†å­—æ®µçš„Indexå±æ€§è®¾ç½®ä¸ºfalseå³å¯ï¼Œæ¯ä¸ªå­—æ®µéƒ½ä¼šæœ‰è¯¥å±æ€§ã€‚å¯ä»¥é™ä½eså†™å…¥æ—¶çš„å¤„ç†é€»è¾‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 PUT myindex { \u0026#34;mappings\u0026#34;: { \u0026#34;properties\u0026#34;: { \u0026#34;content\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;text\u0026#34; }, \u0026#34;name\u0026#34;: { \u0026#34;type\u0026#34;: \u0026#34;text\u0026#34;, \u0026#34;index\u0026#34;: false } } } } ç»“æ„æ‰å¹³åŒ– å°½é‡å‡å°‘ object ç±»å‹çš„ä½¿ç”¨ï¼Œæ›´å»ºè®®å°†æ•°æ®æ‰å¹³åŒ–ã€‚è¶Šæ˜¯å¤æ‚çš„æ•°æ®ç»“æ„ï¼Œç³»ç»Ÿè¦å¤„ç†çš„äº‹æƒ…å°±è¶Šå¤šï¼Œå†™å…¥å°±è¶Šæ…¢ã€‚è€Œä¸” nestedã€parent-child ç­‰æ•°æ®ç±»å‹ï¼Œåœ¨æŸ¥è¯¢æ—¶å€™æ€§èƒ½ä¹Ÿå¾ˆå·®ã€‚\nå¸¸è§åœºæ™¯åº”ç”¨å­—æ®µç±»å‹ å¯¹äºä¸šåŠ¡ç³»ç»Ÿæ¥è¯´ï¼Œè®¾è®¡è¡¨çš„å­—æ®µçš„åœºæ™¯ä¸æ˜¯å¾ˆå¤šï¼Œä¼šæœ‰ä¸€äº›å¸¸è§çš„åœºæ™¯ã€‚è¿™é‡Œåˆ—ä¸€äº›å¸¸è§åœºæ™¯è®¾è®¡çš„å­—æ®µï¼Œä»¥åŠå¯¹åº”çš„esæ•°æ®ç±»å‹ã€‚\nåœºæ™¯å€¼ å­—æ®µç±»å‹ idå€¼ã€çŠ¶æ€æšä¸¾ã€ç±»å‹æšä¸¾ keyword æ—¥æœŸã€æ—¶é—´ã€æ—¶é—´æˆ³ç­‰ date ä»·æ ¼ï¼ˆè½¬æˆåˆ†å­˜å‚¨ï¼‰ long æ—¥æœŸæ—¶é—´èŒƒå›´ï¼ˆå¸¸è§é¢„çº¦æ—¶é—´ç­‰åœºæ™¯ï¼‰ date_range çŸ­å­—ç¬¦ï¼ˆå¦‚åç§°ç­‰likeæŸ¥è¯¢åœºæ™¯ï¼‰ wildcard è¿™é‡Œæ¯”è¾ƒç‰¹åˆ«çš„å°±æ˜¯ä½¿ç”¨wildcardç±»å‹ï¼Œæ¥è§£å†³æ¨¡ç³ŠåŒ¹é…çš„åœºæ™¯ï¼Œå¯¹åº”çš„å°±æ˜¯SQLä¸­çš„likeã€‚è¯¥æ•°æ®ç±»å‹æ˜¯7.9ç‰ˆæœ¬æä¾›çš„ï¼Œå¯¹äºwildcardç±»å‹çš„æ€§èƒ½é—®é¢˜å¯ä»¥å‚è€ƒï¼šElasticsearch æŸ¥è¯¢é©æ–°ï¼šæ¢ç´¢ Wildcard ç±»å‹çš„é«˜æ•ˆæ¨¡ç³ŠåŒ¹é…ç­–ç•¥ã€‚\næ€»ç»“ å½“å‰å¯¹äºESçš„åº”ç”¨ï¼Œè¿˜æ˜¯å¤„äºæ¯”è¾ƒç®€å•çš„æ°´å¹³ï¼Œè§£å†³ä¸€äº›å¤æ‚æŸ¥è¯¢å’ŒèšåˆæŸ¥è¯¢çš„åœºæ™¯ï¼Œç¼“è§£MySQLçš„å‹åŠ›ã€‚æŸ¥è¯¢æ¡ä»¶ä¹Ÿæ˜¯åŸºæœ¬å’ŒMySQLåŒºåˆ«ä¸æ˜¯å¤ªå¤§ï¼Œå¤§éƒ½æ˜¯ç­‰å€¼ã€èŒƒå›´ã€likeç­‰ã€‚ è€Œå¯¹äºESæ“…é•¿çš„å…¨æ–‡æœç´¢ã€æ–‡æ¡£è¯„åˆ†ç­‰åŠŸèƒ½ï¼Œå½“å‰ä¸šåŠ¡åœºæ™¯å¹¶æœªä½¿ç”¨è¿‡ã€‚ç­‰å¾…åç»­ç»§ç»­æ¢ç´¢ã€‚\né™„å½• å‚è€ƒ ESå°å†Œï¼š35.å”¯å¿«ä¸ç ´ï¼šå†™è°ƒä¼˜\nElasticsearch æŸ¥è¯¢é©æ–°ï¼šæ¢ç´¢ Wildcard ç±»å‹çš„é«˜æ•ˆæ¨¡ç³ŠåŒ¹é…ç­–ç•¥\n","date":"2024-12-07T11:08:38+08:00","image":"https://gloryjie.github.io/p/es%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/cover_hu02aa61ae1d9de35cbe238d2676170cb9_782219_120x120_fill_q75_box_smart1.jpeg","permalink":"https://gloryjie.github.io/p/es%E5%BA%94%E7%94%A8%E5%AE%9E%E8%B7%B5/","title":"Esåº”ç”¨å®è·µæŒ‡å—"},{"content":" å°é¢ä¸ºã€Šå‡¡äººä¿®ä»™ä¼ ã€‹118é›†å…ƒç‘¶å‡ºæµ´ï¼Œç°åœ¨å·²ç»è¢«å‰ªæ‰äº†\näº†è§£äº†åŸºç¡€çš„çŠ¶æ€æœºæ¦‚å¿µåï¼Œæ¥å®ç°ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºï¼ŒåŒ…å«å‡ å¤§ç»„ä»¶ï¼šçŠ¶æ€Stateã€è½¬å˜Transitionã€äº‹ä»¶Eventã€åŠ¨ä½œActionã€å®ˆæŠ¤æ¡ä»¶Conditionç­‰æ¦‚å¿µç»„ä»¶ã€‚\nçŠ¶æ€State è¡¨ç¤ºçŠ¶æ€å¯ä»¥æ˜¯intã€stringã€enumç­‰ç±»å‹çš„å€¼ï¼Œæ‰€ä»¥å®šä¹‰ä¸€ä¸ªæ¥å£ï¼Œè·å–æ³›å‹çš„å€¼ã€‚\n1 2 3 4 5 public interface FsmState\u0026lt;T\u0026gt; { T value(); } äº‹ä»¶Event äº‹ä»¶å’ŒStateç±»ä¼¼çš„ï¼Œéƒ½å¯ä»¥ç”¨intã€stringã€enumç­‰è¡¨ç¤ºã€‚\n1 2 3 4 5 public interface FsmEvent\u0026lt;T\u0026gt; { T value(); } äº‹ä»¶å’ŒçŠ¶æ€çš„ä¸‰å…ƒç»„ å®šä¹‰ä¸€ä¸ªä¸‰å…ƒç»„ï¼Œæ¥æè¿°å½“å‰çŠ¶æ€ï¼Œå‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…ï¼Œç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 @Getter @AllArgsConstructor public class FsmTransitionUnit\u0026lt;S,E\u0026gt; { /** * ç°æ€ */ private FsmState\u0026lt;S\u0026gt; sourceState; /** * å…³è”çš„äº‹ä»¶ */ private FsmEvent\u0026lt;E\u0026gt; event; /** * æ¬¡æ€ */ private FsmState\u0026lt;S\u0026gt; targetState; } çŠ¶æ€æµè½¬ä¸Šä¸‹æ–‡ å½“å‘ç”Ÿäº†äº‹ä»¶åï¼Œä¼šè§¦å‘çŠ¶æ€æµè½¬Transitionï¼Œè€ŒTransitionä¸­éœ€è¦æ„ŸçŸ¥åˆ°å½“å‰çš„ä¸Šä¸‹æ–‡æƒ…å†µ\nå½“å‰çŠ¶æ€æ˜¯ä»€ä¹ˆsourceState å‘ç”Ÿäº†ä»€ä¹ˆäº‹æƒ…Event æµè½¬åˆ°çš„ç›®æ ‡çŠ¶æ€æ˜¯ä»€ä¹ˆtargetState é™¤äº†çŠ¶æ€æœºæœ¬èº«éœ€è¦çš„ä¸Šä¸‹æ–‡å¤–ï¼Œè¿˜å…è®¸æºå¸¦ä¸€äº›è‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡æ•°æ®å¯¹è±¡ 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public interface FsmStateContext\u0026lt;S, E, C\u0026gt; { /** * å½“å‰çŠ¶æ€ */ FsmState\u0026lt;S\u0026gt; sourceState(); /** * æ¬¡æ€ï¼ˆç›®æ ‡çŠ¶æ€ï¼‰ */ FsmState\u0026lt;S\u0026gt; targetState(); /** * è§¦å‘äº‹ä»¶ */ FsmEvent\u0026lt;E\u0026gt; event(); /** * è‡ªå®šä¹‰ä¸Šä¸‹æ–‡å¯¹è±¡ */ C context(); } çŠ¶æ€æµè½¬Transition çŠ¶æ€æµè½¬Transitionå…¶å®æ˜¯å¤šä¸ªåŠ¨ä½œçš„ç»„åˆ\nonConditionï¼šæ ¹æ®ä¸Šä¸‹æ–‡åˆ¤æ–­æ˜¯å¦å¯ä»¥æ‰§è¡ŒActionï¼Œå¯ä»¥æ²¡æœ‰ onActionï¼šæ‰§è¡Œå…·ä½“çš„Action afterActionï¼šæ‰§è¡Œå®ŒActionä¹‹åå¯ä»¥åšä¸€äº›åç½®å¤„ç†ï¼Œå¯ä»¥æ²¡æœ‰ å¯ä»¥çœ‹åˆ°è¿™ä¸‰ä¸ªæ–¹æ³•çš„å‚æ•°éƒ½æ˜¯FsmStateContextï¼Œå¯ä»¥è·å–åˆ°çŠ¶æ€æœºè‡ªèº«çš„çŠ¶æ€æƒ…å†µï¼Œä»¥åŠè‡ªå®šä¹‰çš„ä¸Šä¸‹æ–‡æ•°æ®å¯¹è±¡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 public interface FsmStateTransition\u0026lt;S, E, C\u0026gt; { /** * æ‰§è¡ŒåŠ¨ä½œä¹‹å‰ï¼Œåˆ¤æ–­çŠ¶æ€æ˜¯å¦è¿è¡Œæ‰§è¡Œ * * @return æ˜¯å¦å¯ä»¥æ‰§è¡Œtransition */ default boolean onCondition(FsmStateContext\u0026lt;S, E, C\u0026gt; fsmStateContext) { return true; } /** * å®é™…çš„åŠ¨ä½œæ‰§è¡Œ */ void onAction(FsmStateContext\u0026lt;S, E, C\u0026gt; fsmStateContext); /** * actionæ‰§è¡Œå®Œæˆä¹‹åçš„å¤„ç†, åšä¸€äº›æ”¶å°¾åŠ¨ä½œ */ default void afterAction(FsmStateContext\u0026lt;S, E, C\u0026gt; fsmStateContext) { } } çŠ¶æ€æœºStateMachine çŠ¶æ€æœºå®ä¾‹ä¸»è¦è´Ÿè´£ä¸¤ä¸ªåŠŸèƒ½\næå‰é…ç½®å¥½ç›¸å…³çŠ¶æ€ä¹‹é—´çš„æµè½¬å…³ç³» è§¦å‘æŸäº‹ä»¶æ¥è¿›è¡ŒçŠ¶æ€æµè½¬ 1 2 3 4 5 6 7 8 9 10 11 12 13 public interface FsmStateMachine\u0026lt;S, E\u0026gt; { /** * æ³¨å†Œè½¬æ¢Transition */ void registerTransition(FsmTransitionUnit\u0026lt;S, E\u0026gt; transitionUnit, FsmStateTransition\u0026lt;S, E, ?\u0026gt; transition); /** * è§¦å‘çŠ¶æ€å˜æ›´çš„äº‹ä»¶ */ boolean fireEvent(FsmState\u0026lt;S\u0026gt; sourceState, FsmEvent\u0026lt;E\u0026gt; event, Object context); } ä¸€ä¸ªç®€æ˜“çŠ¶æ€æœºçš„å®ç°ç±»æ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯åœ¨çŠ¶æ€æœºå†…éƒ¨éœ€è¦ç»´æŠ¤çŠ¶æ€æµè½¬çš„å…³ç³»ï¼Œä¸‹é¢æ˜¯å‡ ä¸ªè®¾è®¡å…³é”®ç‚¹\nè¿™é‡ŒæŠŠ\u0026lt;sourceState, event \u0026gt;æ‹¼æ¥èµ·æ¥åšä¸ºä¸€ä¸ªkeyï¼Œæ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªTransition è€Œå¤–ç»´æŠ¤ä¸€ä¸ª\u0026lt;sourceState, event\u0026gt; åˆ° targetStateçš„å…³ç³» å†…éƒ¨ç®€å•å®ç°äº†FsmStateContextï¼Œä¸å¯¹å¤–æš´éœ²å…·ä½“çš„å®ç° å…·ä½“ä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 public class DefaultStateMachine\u0026lt;S, E\u0026gt; implements FsmStateMachine\u0026lt;S, E\u0026gt; { private static final String SEPARATOR = \u0026#34;_TO_\u0026#34;; ConcurrentHashMap\u0026lt;String, FsmStateTransition\u0026lt;S, E,?\u0026gt;\u0026gt; stateTransitionMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); ConcurrentHashMap\u0026lt;String, FsmState\u0026lt;S\u0026gt;\u0026gt; targetStateMap = new ConcurrentHashMap\u0026lt;\u0026gt;(); @Override public synchronized void registerTransition(FsmTransitionUnit\u0026lt;S, E\u0026gt; transitionUnit, FsmStateTransition\u0026lt;S, E, ?\u0026gt; transition) { Objects.requireNonNull(transitionUnit, \u0026#34;transitionUnit cannot be null\u0026#34;); Objects.requireNonNull(transition, \u0026#34;transition cannot be null\u0026#34;); Objects.requireNonNull(transitionUnit.getSourceState(), \u0026#34;sourceState cannot be null\u0026#34;); Objects.requireNonNull(transitionUnit.getEvent(), \u0026#34;event cannot be null\u0026#34;); Objects.requireNonNull(transitionUnit.getTargetState(), \u0026#34;targetState cannot be null\u0026#34;); String key = transitionUnit.getSourceState().value().toString() + SEPARATOR + transitionUnit.getEvent().value().toString(); if (stateTransitionMap.containsKey(key)) { throw new IllegalArgumentException(\u0026#34;transitionUnit already registered\u0026#34;); } stateTransitionMap.put(key, transition); targetStateMap.put(key, transitionUnit.getTargetState()); } @Override public boolean fireEvent(FsmState\u0026lt;S\u0026gt; sourceState, FsmEvent\u0026lt;E\u0026gt; event, Object context) { Objects.requireNonNull(sourceState, \u0026#34;sourceState cannot be null\u0026#34;); Objects.requireNonNull(event, \u0026#34;event cannot be null\u0026#34;); String key = sourceState.value().toString() + SEPARATOR + event.value().toString(); FsmStateTransition stateTransition = stateTransitionMap.get(key); if (stateTransition == null) { return false; } FsmState\u0026lt;S\u0026gt; targetState = targetStateMap.get(key); DefaultStateContext\u0026lt;S, E, Object\u0026gt; contextImpl = new DefaultStateContext\u0026lt;\u0026gt;(sourceState, targetState, event, context); boolean conditionResult = stateTransition.onCondition(contextImpl); if (conditionResult) { stateTransition.onAction(contextImpl); stateTransition.afterAction(contextImpl); return true; } return false; } @AllArgsConstructor static class DefaultStateContext\u0026lt;S,E, C\u0026gt; implements FsmStateContext\u0026lt;S,E, C\u0026gt; { private FsmState\u0026lt;S\u0026gt; source; private FsmState\u0026lt;S\u0026gt; target; private FsmEvent\u0026lt;E\u0026gt; event; private C context; @Override public FsmState\u0026lt;S\u0026gt; sourceState() { return source; } @Override public FsmState\u0026lt;S\u0026gt; targetState() { return target; } @Override public FsmEvent\u0026lt;E\u0026gt; event() { return event; } @Override public C context() { return context; } } } å®è·µdemo åŸºäºæ”¯ä»˜å•çš„æ¨¡å‹æ¥ï¼Œåœ¨ä¸Šè¿°è®¾è®¡ä¸Šåšä¸ªå®è·µdemoã€‚\næ”¯ä»˜å•çš„çŠ¶æ€è®¾è®¡ï¼šåˆå§‹ã€å¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²é€€æ¬¾ã€å·²å–æ¶ˆ\n1 2 3 4 5 6 7 8 9 public enum StateEnum implements FsmState\u0026lt;StateEnum\u0026gt; { INIT, WAIT_PAY, PAYED, REFUND, CANCEL; @Override public StateEnum value() { return this; } } æ”¯ä»˜å•ç›¸å…³äº‹ä»¶ï¼šåˆ›å»ºäº‹ä»¶ã€æ”¯ä»˜äº‹ä»¶ã€å–æ¶ˆæ—¶é—´ã€é€€æ¬¾äº‹ä»¶\n1 2 3 4 5 6 7 8 9 10 11 12 public enum EventEnum implements FsmEvent\u0026lt;EventEnum\u0026gt; { CREATE_EVENT, PAY_EVENT, CANCEL_EVENT, REFUND_EVENT; @Override public EventEnum value() { return this; } } å®šä¹‰å„ç§Transitionï¼Œè¿™é‡Œä»¥å¤„ç†æ”¯ä»˜äº‹ä»¶ä¸ºä¾‹ï¼Œå…¶ä½™çš„éƒ½ç±»ä¼¼ï¼Œåªæ˜¯ç®€å•æ‰“å°æ—¥å¿—\n1 2 3 4 5 6 7 8 9 @Slf4j public class PayedTransition implements FsmStateTransition\u0026lt;StateEnum, EventEnum, String\u0026gt; { @Override public void onAction(FsmStateContext\u0026lt;StateEnum, EventEnum, String\u0026gt; fsmStateContext) { log.info(\u0026#34;orderNo={} pay success\u0026#34;, fsmStateContext.context()); } } æ¥ä¸‹æ¥åˆå§‹åŒ–StateMachineå®ä¾‹ï¼Œå¹¶é…ç½®çŠ¶æ€æµè½¬è¿‡ç¨‹ï¼Œç®€å•çš„è¯´å°±æ˜¯é…ç½®4ä¸ªå…ƒç´ \nå½“å‰çŠ¶æ€ å‘ç”Ÿçš„äº‹ä»¶ ç›®æ ‡çŠ¶æ€ éœ€è¦æ‰§è¡Œçš„åŠ¨ä½œ 1 2 3 4 5 FsmStateMachine\u0026lt;StateEnum, EventEnum\u0026gt; fsmStateMachine = new DefaultStateMachine\u0026lt;\u0026gt;(); fsmStateMachine.registerTransition(new FsmTransitionUnit\u0026lt;\u0026gt;(StateEnum.INIT, EventEnum.CREATE_EVENT, StateEnum.WAIT_PAY), new CreatePayOrderTransition()); fsmStateMachine.registerTransition(new FsmTransitionUnit\u0026lt;\u0026gt;(StateEnum.WAIT_PAY, EventEnum.PAY_EVENT, StateEnum.PAYED), new PayedTransition()); fsmStateMachine.registerTransition(new FsmTransitionUnit\u0026lt;\u0026gt;(StateEnum.WAIT_PAY, EventEnum.CANCEL_EVENT, StateEnum.CANCEL), new CancelTransition()); fsmStateMachine.registerTransition(new FsmTransitionUnit\u0026lt;\u0026gt;(StateEnum.PAYED, EventEnum.REFUND_EVENT, StateEnum.REFUND), new RefundTransition()); æ¥ä¸‹æ¥è§¦å‘äº‹ä»¶\n1 2 3 4 5 6 7 8 9 10 11 // æ­£å¸¸çš„çŠ¶æ€æµè½¬ fsmStateMachine.fireEvent(StateEnum.INIT, EventEnum.CREATE_EVENT, \u0026#34;12345678\u0026#34;); fsmStateMachine.fireEvent(StateEnum.WAIT_PAY, EventEnum.PAY_EVENT, \u0026#34;12345678\u0026#34;); fsmStateMachine.fireEvent(StateEnum.WAIT_PAY, EventEnum.CANCEL_EVENT, \u0026#34;12345678\u0026#34;); fsmStateMachine.fireEvent(StateEnum.PAYED, EventEnum.REFUND_EVENT, \u0026#34;12345678\u0026#34;); // å¼‚å¸¸æµè½¬ boolean res = fsmStateMachine.fireEvent(StateEnum.INIT, EventEnum.REFUND_EVENT, \u0026#34;12345678\u0026#34;); if (!res) { log.error(\u0026#34;This event={} should not occur in the state={}\u0026#34;, EventEnum.REFUND_EVENT,StateEnum.INIT); } èƒ½å¤Ÿæ­£å¸¸æµè½¬çš„çŠ¶æ€ï¼Œéƒ½é€šè¿‡Transitionæ‰§è¡Œå¹¶æ‰“å°äº†æ—¥å¿—ã€‚\n1 2 3 4 5 10:37:56.810 [main] INFO com.example.stateMachine.test.CreatePayOrderTransition - orderNo=12345678 pay order create success 10:37:56.812 [main] INFO com.example.stateMachine.test.PayedTransition - orderNo=12345678 pay success 10:37:56.812 [main] INFO com.example.stateMachine.test.CancelTransition - orderNo=12345678 cancel success 10:37:56.812 [main] INFO com.example.stateMachine.test.RefundTransition - orderNo=12345678 refund success 10:37:56.812 [main] ERROR com.example.stateMachine.test.StateMachineTest - This event=REFUND_EVENT should not occur in the state=INIT æ€»ç»“ åŸºäºæœ‰é™çŠ¶æ€æœºFSMçš„åŸºç¡€æ¦‚å¿µæ¥å®ç°ä¸€ä¸ªç®€å•çš„çŠ¶æ€æœºï¼Œå›Šæ‹¬äº†åŸºæœ¬çš„åŠŸèƒ½ï¼šStateã€Eventã€Transitionã€Conditionã€Actionç­‰ï¼Œå¯ä»¥å®ç°åŸºæœ¬çš„çŠ¶æ€æµè½¬ã€‚è¿™é‡Œè¿˜æ˜¯ç¼ºå°‘äº†ä¸€äº›ä¸œè¥¿ï¼Œå¦‚InternalTransitionï¼Œæ›´å¤šç±»å‹çš„Actionç­‰ã€‚åœ¨çŠ¶æ€æœºé…ç½®ä¸Šï¼Œç¼ºå°‘äº†ä¸€äº›è¯­ä¹‰åŒ–å±‚é¢çš„ä¸œè¥¿ï¼Œä¸å¤Ÿç›´è§‚ã€‚åè¾¹ä¼šå¯¹SpringStateMachineã€COLAStateMachineè¿›è¡Œä»‹ç»ã€‚\né™„å½• å‚è€ƒ ","date":"2024-09-15T09:41:29+08:00","image":"https://gloryjie.github.io/p/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%AF%87%E4%BA%8C%E7%AE%80%E6%98%93%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9E%E7%8E%B0/cover_hu47e7782123627053c1d5b077eb2da475_2213880_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%AF%87%E4%BA%8C%E7%AE%80%E6%98%93%E7%8A%B6%E6%80%81%E6%9C%BA%E5%AE%9E%E7%8E%B0/","title":"çŠ¶æ€æœºç¯‡äºŒï¼šç®€æ˜“çŠ¶æ€æœºå®ç°"},{"content":" å°é¢æ¥è‡ªã€Šè¯›ä»™ã€‹48é›†ï¼Œé™†é›ªçª\næŸå¤©ï¼Œæœ‹å‹é—®äº‹åŠ¡æ€ä¹ˆå¤±æ•ˆäº†ï¼Œæ³¨è§£å’Œæ‰‹åŠ¨äº‹åŠ¡éƒ½è¯•è¿‡äº†ï¼Œè€Œä¸”debugèµ°ä»£ç ç¡®å®èµ°åˆ°äº†Springçš„äº‹åŠ¡æ³¨è§£æ‹¦æˆªå™¨é‡Œè¾¹äº†ã€‚å’Œä»–æ¢è®¨äº†ä¸€ä¸‹ï¼ŒåŸæ¥æ˜¯ä»–é¡¹ç›®é…ç½®äº†å¤šä¸ªå¯å†™æ•°æ®æºçš„åŸå› ã€‚è¿™ç§æƒ…å†µè‡ªå·±ç¡®å®æ²¡æœ‰é‡åˆ°è¿‡ï¼Œé‚è®°å½•ä¸€ä¸‹ã€‚\nç¯å¢ƒ\u0026amp;æ•°æ®å‡†å¤‡ è¿™é‡Œä½¿ç”¨çš„ç¯å¢ƒå¦‚ä¸‹\nJDK17 SpringBoot3.3.3 pomä¾èµ–å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-web\u0026lt;/artifactId\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;com.mysql\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mysql-connector-j\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;runtime\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.projectlombok\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;lombok\u0026lt;/artifactId\u0026gt; \u0026lt;optional\u0026gt;true\u0026lt;/optional\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.springframework.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;spring-boot-starter-test\u0026lt;/artifactId\u0026gt; \u0026lt;scope\u0026gt;test\u0026lt;/scope\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.mybatis.spring.boot\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;mybatis-spring-boot-starter\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;3.0.3\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å…ˆåˆ›å»ºä¸¤ä¸ªåº“\nåˆ›å»ºåº“testAï¼Œåˆ›å»ºè¡¨user åˆ›å»ºåº“testBï¼Œåˆ›å»ºè¡¨addr 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 create table user ( id bigint auto_increment comment \u0026#39;ä¸»é”®ID\u0026#39; primary key, name varchar(30) null comment \u0026#39;å§“å\u0026#39;, age int null comment \u0026#39;å¹´é¾„\u0026#39;, email varchar(50) null comment \u0026#39;é‚®ç®±\u0026#39; ); create table addr ( id int auto_increment primary key, uid int null, address varchar(128) null ); INSERT INTO testA.user (id, name, age, email) VALUES (1, \u0026#39;JOJO\u0026#39;, 22, \u0026#39;123@abc.com\u0026#39;); INSERT INTO testB.addr (id, uid, address) VALUES (1, 1, \u0026#39;å¹¿ä¸œçœXXXå¸‚\u0026#39;); Mybatisè‡ªåŠ¨åŒ–é…ç½® å…ˆçœ‹ä¸‹Mybatisçš„è‡ªåŠ¨åŒ–é…ç½®æ˜¯æ€æ ·çš„ Mybatisçš„è‡ªåŠ¨åŒ–é…ç½®åªæ”¯æŒå•ä¸€çš„æ•°æ®æºï¼Œå¹¶ä¸”æ„å»ºäº†ä¸¤ä¸ªé‡è¦çš„ç»„ä»¶ï¼šSqlSessionFactoryã€SqlSessionTemplateã€‚è‹¥é…ç½®å¤šæ•°æ®æºçš„è¯ï¼Œéœ€è¦è‡ªå·±åˆ›å»ºè¿™ä¸¤ä¸ªç»„ä»¶ã€‚\nåœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­ï¼Œé€šå¸¸ä¼šåœ¨SpringBootçš„å¯åŠ¨ç±»ä¸ŠåŠ @MapperScançš„æ³¨è§£ï¼Œä¼šæ‰«æMapperæ¥å£ï¼Œç”Ÿæˆå¯¹åº”çš„ä»£ç†å®ç°ç±»ã€‚è¿™é‡Œè¾¹æœ‰ä¸¤ä¸ªå±æ€§æ¯”è¾ƒé‡è¦ï¼šsqlSessionFactoryRefã€sqlSessionTemplateRefï¼Œå¯ä»¥æŒ‡å®šç”Ÿæˆçš„ä»£ç†å®ç°ç±»æ‰€ä½¿ç”¨çš„SqlSessionFactoryã€SqlSessionTemplateå®ä¾‹ã€‚\nåœ¨å’ŒSpringBootæ•´åˆçš„æ—¶å€™ï¼Œåªéœ€è¦æŒ‡å®šsqlSessionTemplateå³å¯ï¼Œå› ä¸ºè¯¥ç±»å°±æ˜¯Mybatis-SpringåŒ…ä¸­é€‚é…Springç¯å¢ƒçš„ã€‚\nå¤šæ•°æ®æºé…ç½® è‡ªå®šä¹‰æ•°æ®æºé…ç½®Mybatisï¼Œå¯ä»¥è·Ÿç€MybatisAutoConfigurationæ¥è‡ªå·±å†™é…ç½®ï¼Œå¹¶ä¸”é€šè¿‡@MapperScanæ¥æŒ‡å®šå¯¹åº”çš„Mapperä»£ç†ä½¿ç”¨çš„SqlSessionTemplateå®ä¾‹ã€‚@MapperScan æ˜¯æ ¹æ®åŒ…æ¥æ‰«æçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çš„Mapperéœ€è¦æ ¹æ®DataSourceæ¥åˆ†packageã€‚\né™¤äº†Mybatisçš„é…ç½®å¤–ï¼Œæˆ‘ä»¬è¿˜éœ€è¦è¿›è¡ŒSpringBootçš„TransactionManageré…ç½®ï¼Œæ˜¯å’ŒDataSourceå…³è”çš„ï¼Œå¦‚æœé…ç½®äº†å¤šä¸ªDataSourceï¼Œé‚£ä¹ˆå°±è¦ç›¸å¯¹åº”çš„é…ç½®å¯¹åº”çš„TransactionManagerã€‚\nä¸‹æ¥çœ‹ä¸‹ymlçš„é…ç½®ï¼Œæ²¡ä»€ä¹ˆç‰¹åˆ«çš„ï¼Œåªæ˜¯é…ç½®ä¸¤ä¸ªæ•°æ®æº\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 spring: application: name: spring-demo datasource: user: type: com.zaxxer.hikari.HikariDataSource driver-class-name: com.mysql.cj.jdbc.Driver jdbcUrl: jdbc:mysql://localhost:3306/testA username: root password: 123456 addr: type: com.zaxxer.hikari.HikariDataSource driver-class-name: com.mysql.cj.jdbc.Driver jdbcUrl: jdbc:mysql://localhost:3306/testB username: root password: 123456 æ¥ä¸‹æ¥å°±è¦å¯¹DataSourceã€SqlSessionFactoryã€SqlSessionTemplateã€@MapperScanè¿›è¡Œé…ç½®äº†ã€‚å…ˆæ¥çœ‹çœ‹useråº“çš„é…ç½®ï¼Œè¿™é‡ŒæŠŠä»–ä½œä¸ºPrimaryã€‚å¯¹äºMybatisçš„ä¼—å¤šé…ç½®ï¼Œå¦‚xmlçš„æ‰«æè·¯å¾„ã€æ’ä»¶é…ç½®ç­‰ï¼Œéƒ½å¯ä»¥åœ¨æ„å»ºSqlSessionFactoryçš„æ–¹æ³•å†…è¿›è¡Œã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Configuration @MapperScan(value = \u0026#34;com.example.springdemo.mapper.user\u0026#34;, sqlSessionTemplateRef = \u0026#34;userSqlSessionTemplate\u0026#34;) public class UserDataSourceConfig { @Primary @Bean(\u0026#34;userDataSource\u0026#34;) @ConfigurationProperties(prefix = \u0026#34;spring.datasource.user\u0026#34;) public DataSource userDataSource() { return DataSourceBuilder.create().build(); } @Primary @Bean public PlatformTransactionManager userTransactionManager(@Qualifier(\u0026#34;userDataSource\u0026#34;) DataSource dataSource) { return new JdbcTransactionManager(dataSource); } @Primary @Bean public SqlSessionFactory userSqlSessionFactory(@Qualifier(\u0026#34;userDataSource\u0026#34;) DataSource dataSource) throws Exception { SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(dataSource); return sqlSessionFactoryBean.getObject(); } @Primary @Bean public SqlSessionTemplate userSqlSessionTemplate(@Qualifier(\u0026#34;userSqlSessionFactory\u0026#34;) SqlSessionFactory sqlSessionFactory) { return new SqlSessionTemplate(sqlSessionFactory); } } åŒæ ·çš„ï¼Œè¿›è¡Œaddræ•°æ®æºçš„ç›¸å…³é…ç½®ï¼Œä¸åŒåœ¨äºè¿™é‡Œä¹Ÿæ²¡æœ‰Primaryã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Configuration @MapperScan(value = \u0026#34;com.example.springdemo.mapper.addr\u0026#34;, sqlSessionTemplateRef = \u0026#34;addrSqlSessionTemplate\u0026#34;) public class AddrDataSourceConfig { @Bean(\u0026#34;addrDataSource\u0026#34;) @ConfigurationProperties(prefix = \u0026#34;spring.datasource.addr\u0026#34;) public DataSource addrDataSource() { return DataSourceBuilder.create().build(); } @Bean public PlatformTransactionManager addrTransactionManager( @Qualifier(\u0026#34;addrDataSource\u0026#34;) DataSource dataSource) { return new JdbcTransactionManager(dataSource); } @Bean public SqlSessionFactory addrSqlSessionFactory(@Qualifier(\u0026#34;addrDataSource\u0026#34;) DataSource dataSource) throws Exception { SqlSessionFactoryBean sqlSessionFactoryBean = new SqlSessionFactoryBean(); sqlSessionFactoryBean.setDataSource(dataSource); // è¿™é‡Œè¿›è¡ŒMybatisé…ç½® return sqlSessionFactoryBean.getObject(); } @Bean public SqlSessionTemplate addrSqlSessionTemplate(@Qualifier(\u0026#34;addrSqlSessionFactory\u0026#34;) SqlSessionFactory sqlSessionFactory) { return new SqlSessionTemplate(sqlSessionFactory); } } è¿™é‡Œéœ€è¦æ³¨æ„äº†ï¼Œ@MapperScanæ³¨è§£ä¸Šçš„valueï¼Œä¹Ÿå°±æ˜¯basePackageçš„å€¼ï¼Œæ˜¯æŒ‡å®šäº†ä¸åŒç›®å½•çš„ï¼Œä¸åŒæ•°æ®æºçš„Mapperè¦é€šè¿‡ä¸åŒçš„åŒ…è¿›è¡Œå½’ç±»ï¼Œä¸åŒæ”¾åœ¨ä¸€èµ·ã€‚ æµ‹è¯•é…ç½® æ¥ä¸‹æ¥è¿›è¡Œæµ‹è¯•ï¼Œè¿™é‡Œå¼•å…¥äº†webé¡¹ç›®ï¼Œå¼€äº†ä¸¤ä¸ªæŸ¥è¯¢æ¥å£ã€‚ä¸‹é¢æ˜¯IDEAçš„httpé…ç½®\n1 2 3 4 5 ### GET http://localhost:8080/user/1 ### GET http://localhost:8080/addr/1 åˆ†åˆ«è°ƒç”¨è¿™ä¿©æ¥å£çš„æ—¶å€™ï¼Œè·å–çš„æ•°æ®éƒ½æ˜¯æ­£å¸¸çš„ï¼Œå¯ä»¥çœ‹åˆ°æ—¥å¿—çš„æ‰“å°ï¼Œåˆ†åˆ«å¯åŠ¨äº†ä¸¤ä¸ªæ•°æ®æºã€‚ è‡³æ­¤ï¼Œä¸¤ä¸ªæ•°æ®æºçš„é…ç½®å®Œæˆã€‚\näº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯ å¦‚æœä¸€ä¸ªæ–¹æ³•åŒæ—¶ä¿®æ”¹ä¸¤ä¸ªæ•°æ®æºï¼Œå•æ•°æ®æºäº‹åŠ¡ä¸ç”Ÿæ•ˆå¾ˆæ­£å¸¸ï¼Œæ¶‰åŠåˆ°åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚è¿™é‡Œä¸»è¦æ¢è®¨åˆ†æçš„æ˜¯æ›´æ–°å•ä¸ªæ•°æ®æºäº‹åŠ¡å¤±æ•ˆçš„æƒ…å†µã€‚\nåŸºäºä¸Šè¿°é…ç½®ï¼Œæ›´æ–°çœ‹ä¸‹ä¸‹é¢çš„ç¤ºä¾‹ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 // å¤šæ•°æ®æºæ›´æ–° @Transactional public void updateInfo() { // è¿™ä¸ªä¼šå›æ»š userMapper.update(); // è¿™ä¸ªä¸ä¼šå›æ»š addrMapper.update(); throw new RuntimeException(\u0026#34;test rollback\u0026#34;); } // å•æ•°æ®æºæ›´æ–° @Transactional public void updateInfo() { // è¿™ä¸ªä¸ä¼šå›æ»š addrMapper.update(); throw new RuntimeException(\u0026#34;test rollback\u0026#34;); } ç¤ºä¾‹ä»£ç ä¸­äº‹åŠ¡éƒ½æ˜¯å¤±æ•ˆçš„çš„ï¼Œä¸¤ä¸ªæ•°æ®å·²ç»å‘ç”Ÿäº†å˜æ›´ï¼Œå›æ»šä¸ç”Ÿæ•ˆã€‚ä¸‹é¢ä»¥ç¬¬äºŒä¸ªæ›´æ–°å•ä¸ªæ•°æ®æºçš„ç¤ºä¾‹æ¥åˆ†æä¸‹åŸå› ã€‚ å…ˆå›é¡¾ä¸‹é…ç½®\nä¸»æ•°æ®æºæ˜¯userï¼Œä¸»äº‹åŠ¡ç®¡ç†å™¨æ˜¯userTransactionManager è¿˜æœ‰æ•°æ®æºaddrï¼Œå…¶å¯¹åº”çš„äº‹åŠ¡ç®¡ç†å™¨ä¸ºaddrTransactionManager åœ¨äº‹åŠ¡æ³¨è§£@TransactionalæœªæŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨çš„æƒ…å†µä¸‹ï¼Œä½¿ç”¨é»˜è®¤çš„äº‹åŠ¡ç®¡ç†å™¨userTransactionManager ï¼Œä¹Ÿå°±æ˜¯ä½¿ç”¨çš„æ˜¯userçš„æ•°æ®æºã€‚é‚£ä¹ˆupdateInfoæ–¹æ³•å¼€å¯çš„å°±æ˜¯useræ•°æ®æºçš„äº‹åŠ¡ã€‚ç„¶è€Œ\naddrMapperä½¿ç”¨çš„æ˜¯addræ•°æ®æºï¼Œè‡ªå·±çš„ç‹¬ç«‹äº‹åŠ¡ åœ¨æ‰§è¡Œåˆ°æ‰‹åŠ¨æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼ŒaddrMapper.updateæ‰€å±æ•°æ®æºaddrçš„äº‹åŠ¡å·²ç»æäº¤äº†ï¼Œä½†æ˜¯userçš„äº‹åŠ¡è¿˜åœ¨è¿›è¡Œä¸­ï¼Œå½“æŠ›å‡ºå¼‚å¸¸çš„æ—¶å€™ï¼ŒSpringä¼šæ•è·è¯¥å¼‚å¸¸å¹¶ä¸”å›æ»šuserçš„äº‹åŠ¡ã€‚è¿™å°±æ˜¯äº‹åŠ¡å¤±æ•ˆçš„åŸå› ï¼Œä¸ºè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œéœ€è¦åœ¨äº‹åŠ¡æ³¨è§£æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨\n@Transactional(value = \u0026ldquo;addrTransactionManager\u0026rdquo;)\næ€»ç»“äº‹åŠ¡å¤±æ•ˆçš„åœºæ™¯å°±æ˜¯ï¼šäº‹åŠ¡æ³¨è§£ä½¿ç”¨çš„äº‹åŠ¡ç®¡ç†å™¨è¦å’Œæ–¹æ³•å†…éƒ¨æ“ä½œçš„æ•°æ®æºå¯¹åº”ï¼Œå¦åˆ™äº‹åŠ¡ä¸ç”Ÿæ•ˆã€‚\næ€»ç»“ SpringBoot+Mybatisçš„å¤šæ•°æ®æºé…ç½®æ¼”ç¤ºå®Œæˆäº†ï¼Œä¸»è¦æ˜¯éœ€è¦é…ç½®å¦‚ä¸‹ç»„ä»¶\nDataSource TransactionManager SqlSessionFactory SqlSessionTemplate é™¤äº†è¿™å››ä¸ªç»„ä»¶å¤–ï¼Œå¹¶ä¸”åœ¨Mapperçš„ä½¿ç”¨ä¸Šï¼Œéœ€è¦æ ¹æ®æ•°æ®æºè¿›è¡Œåˆ†packageï¼Œå¹¶ä¸”äº‹åŠ¡æ³¨è§£@Transactionaléœ€è¦æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ã€‚\nè¿™ç§é…ç½®æ–¹å¼ï¼Œæœ‰ä¸ªå¾ˆæ˜æ˜¾çš„ç¼ºç‚¹ï¼šæœ‰å¤šå°‘ä¸ªæ•°æ®æºï¼Œå°±å¾—å®ç°å¤šå°‘å¥—ç»„ä»¶çš„é…ç½®ï¼Œå¹¶ä¸”Mapperè¦åˆ†åˆ«å­˜æ”¾ï¼Œäº‹åŠ¡æ³¨è§£è¦æŒ‡å®šäº‹åŠ¡ç®¡ç†å™¨ã€‚è¿™ä¸ªä¸€çœ‹å°±å¾ˆç¹çï¼Œåœ¨å®é™…åº”ç”¨ä¸­è¿™ç§æ–¹å¼æ¯”è¾ƒå°‘è§ï¼Œæ¯•ç«ŸåŒæ—¶å†™å¤šä¸ªæ•°æ®æºåœ¨å®é™…ä¸­å°±åº”è¯¥é¿å…ï¼Œå¦åˆ™å°±æ¶‰åŠåˆ°åˆ†å¸ƒå¼äº‹åŠ¡äº†ã€‚\nSpringæä¾›äº†ä¸€ä¸ªæŠ½è±¡ç±»AbstractRoutingDataSourceæ¥æ›´å¥½çš„æ”¯æŒå¤šæ•°æ®æºçš„é…ç½®ï¼Œè¿™ä¸ªä¸‹ä¸€ç¯‡ä¼šè¿›è¡Œæè¿°ã€‚\né™„å½• å‚è€ƒ ","date":"2024-09-03T11:51:02+08:00","image":"https://gloryjie.github.io/p/springboot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E4%B8%80mybatis%E7%AF%87/cover_hub9c213921ac58281659a82486216fa8d_2043476_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/springboot%E5%A4%9A%E6%95%B0%E6%8D%AE%E6%BA%90%E9%85%8D%E7%BD%AE%E4%B8%80mybatis%E7%AF%87/","title":"SpringBootå¤šæ•°æ®æºé…ç½®ï¼ˆä¸€ï¼‰ï¼šMybatisç¯‡"},{"content":" å°é¢æ¥è‡ªã€Šè¯›ä»™ã€‹48é›†ï¼Œé™†é›ªçª\nçŠ¶æ€é€šå¸¸æ˜¯ç”¨æ¥æè¿°ä¸€ä¸ªäº‹åŠ¡å½“å‰æ˜¯å¤„äºä¸€ä¸ªä»€ä¹ˆé˜¶æ®µï¼ˆçŠ¶æ€ï¼‰ï¼Œåœ¨æ—¥å¸¸ç”Ÿæ´»ä¸­æœ€å¸¸è§çš„å°±æ˜¯ç”µæ°”çš„å¼€å…³çŠ¶æ€äº†ï¼Œå¦‚ç©ºè°ƒã€é£æ‰‡å¼€å…³ç¯ã€‚è€Œåœ¨é€šå¸¸çš„é¡¹ç›®è®¾è®¡ä¸­éƒ½ä¼šåº”ç”¨åˆ°ï¼Œæœ€å¸¸è§çš„å°±æ˜¯è®¢å•çŠ¶æ€äº†ï¼šå¾…æ”¯ä»˜ã€å·²æ”¯ä»˜ã€å·²å–æ¶ˆç­‰çŠ¶æ€ã€‚\næœ‰é™çŠ¶æ€æœºï¼ˆFinite-state Machineï¼ŒFSMï¼‰ï¼Œæ˜¯è¡¨ç¤ºæœ‰é™ä¸ªçŠ¶æ€ä»¥åŠåœ¨è¿™äº›çŠ¶æ€ä¹‹é—´çš„è½¬ç§»å’ŒåŠ¨ä½œç­‰è¡Œä¸ºçš„æ•°å­¦è®¡ç®—æ¨¡å‹ã€‚å°±æ˜¯å¯¹ç°å®äº‹ç‰©è¿è¡ŒçŠ¶æ€ç®¡ç†è¿›è¡ŒæŠ½è±¡ï¼Œå½¢æˆäº†ä¸€å¥—çŠ¶æ€æœºçš„æ¦‚å¿µã€‚\nåŸºç¡€æ¦‚å¿µ FSMæœ‰éå¸¸å¤šçš„æ¦‚å¿µï¼Œè¿™é‡Œä»‹ç»å‡ ä¸ªæ ¸å¿ƒçš„æ¦‚å¿µã€‚çŠ¶æ€æœºåŸºç¡€æ¦‚å¿µæ¦‚æ‹¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼ˆæºè‡ªCOLAçŠ¶æ€æœºæ–‡ç« ï¼‰ çŠ¶æ€State çŠ¶æ€è¿™ä¸ªæ¦‚å¿µå°±å¾ˆå¥½ç†è§£äº†ï¼Œå°±æ˜¯å½“å‰äº‹åŠ¡å¤„äºä¸€ä¸ªä»€ä¹ˆçŠ¶æ€ã€‚åœ¨çŠ¶æ€æœºä¸­ï¼Œè‡³å°‘éœ€è¦2ä¸ªçŠ¶æ€ï¼Œæ¯•ç«Ÿåªæœ‰ä¸€ä¸ªçŠ¶æ€æ ¹æœ¬å°±ä¸éœ€è¦æµè½¬ï¼Œä¹Ÿä¸éœ€è¦ç®¡ç†äº†ã€‚ æœ‰é™çš„çŠ¶æ€é›†åˆé‡Œè¾¹ï¼Œäº‹ç‰©å¿…é¡»åŒ…å«ä¸€ä¸ªèµ·ç‚¹ï¼Œä¹Ÿå°±æ˜¯å¿…é¡»å…·æœ‰åˆå§‹çŠ¶æ€ï¼ˆInitial Stateï¼‰ï¼Œè€Œç»ˆæ€ï¼ˆEnd Stateï¼‰ä¸æ˜¯å¿…é¡»çš„ã€‚\nçŠ¶æ€è½¬å˜Transition çŠ¶æ€çš„åˆ‡æ¢ï¼šåŸçŠ¶æ€è¿‡åº¦åˆ°ç›®æ ‡çŠ¶æ€ï¼Œè¿™ä¸ªè½¬å˜è¿‡ç¨‹ç§°ä¹‹ä¸ºTransitionã€‚çŠ¶æ€çš„è½¬å˜é€šå¸¸æ˜¯ç”±è§¦å‘å™¨å¼•èµ·çš„ï¼Œè¿™é‡Œçš„è§¦å‘å™¨ä¸€ç§æŠ½è±¡ï¼Œå¯ä»¥æ˜¯å®šæ—¶å™¨ã€å„ç§äº‹ä»¶ç­‰ã€‚ï¼ˆå…¶å®è¶…æ—¶ä¹Ÿå¯ä»¥ç†è§£æˆäº‹ä»¶ï¼‰ã€‚ ä½†æ˜¯å¦‚æœå‘ç”Ÿäº†æŸäº›äº‹ä»¶ä½†æ˜¯åŸçŠ¶æ€å’Œç›®æ ‡çŠ¶æ€æ˜¯ä¸€è‡´çš„ï¼Œæ²¡æœ‰å¼•èµ·çŠ¶æ€çš„Transitionã€‚è¿™ç§åœºæ™¯è¿˜æ˜¯æŒºå¸¸è§çš„ï¼Œä¾‹å¦‚è®¢å•æ”¶è´§åœ°å€çš„å˜æ›´ï¼Œè¿™ä¸ªåŠ¨ä½œå¹¶ä¸ä¼šé©±åŠ¨è®¢å•çŠ¶æ€çš„å˜åŒ–ã€‚é‚£ä¹ˆæ˜¯å¦å¯ä»¥ç»§ç»­ä½¿ç”¨è¿™ä¸ªæŠ½è±¡ï¼Ÿ\nä¸ºäº†åŒºåˆ†è¿™ä¸¤ç§æƒ…å†µï¼Œå®šä¹‰äº†ä¸¤ç§çš„Transition\nå†…éƒ¨è½¬å˜ï¼ˆInternalTransitionï¼‰ï¼šåŒä¸€çŠ¶æ€çš„æµè½¬ å¤–éƒ¨è½¬å˜ï¼ˆExternalTransitionï¼‰ï¼šä¸¤ä¸ªä¸åŒçŠ¶æ€ä¹‹é—´çš„æµè½¬ äº‹ä»¶Event äº‹ä»¶æ˜¯é©±åŠ¨çŠ¶æ€åˆ‡æ¢çš„æœ€å¸¸è§çš„æ–¹å¼ï¼Œç®€å•çš„è¯´å°±æ˜¯å‘ç”Ÿäº†æŸäº›äº‹æƒ…ï¼Œä¼šè§¦å‘çŠ¶æ€å˜æ›´ã€‚ä¾‹å¦‚ï¼Œç”¨æˆ·å·²ç»æ”¯ä»˜äº†è®¢å•ï¼Œæ­¤æ—¶è®¢å•éœ€è¦ç”±å¾…æ”¯ä»˜è½¬å˜æˆå·²æ”¯ä»˜çš„çŠ¶æ€ã€‚\nåŠ¨ä½œAction åŠ¨ä½œActionæ˜¯æ›´åŠ å…·ä½“çš„è¡Œä¸ºï¼Œä¾‹å¦‚å¦‚ä½•å®ç°æ¥å®ç°Transitionï¼ŒçŠ¶æ€å‘ç”Ÿè½¬å˜åå¯èƒ½éœ€è¦åšç‚¹å…¶ä»–äº‹æƒ…ï¼Œå¦‚å‘çŸ­ä¿¡ä¹‹ç±»çš„åŠ¨ä½œã€‚ å¯ä»¥ç†è§£ä¸ºåŸçŠ¶æ€åˆ°ç›®æ ‡çŠ¶æ€çš„Transitionæ˜¯ç”±å¤šä¸ªActionç»„æˆçš„\nè½¬ç§»åŠ¨ä½œï¼ˆTransition Actionsï¼‰ï¼šåœ¨çŠ¶æ€è½¬ç§»è¿‡ç¨‹ä¸­æ‰§è¡Œçš„åŠ¨ä½œã€‚ è¿›å…¥åŠ¨ä½œï¼ˆEntry Actionsï¼‰ï¼šåœ¨è¿›å…¥æŸä¸ªçŠ¶æ€æ—¶æ‰§è¡Œçš„åŠ¨ä½œã€‚ é€€å‡ºåŠ¨ä½œï¼ˆExit Actionsï¼‰ï¼šåœ¨é€€å‡ºæŸä¸ªçŠ¶æ€æ—¶æ‰§è¡Œçš„åŠ¨ä½œã€‚ å®ˆæŠ¤æ¡ä»¶Condition Conditionæ˜¯å¯¹\u0026lt;çŠ¶æ€ï¼Œäº‹ä»¶\u0026gt;è¿™ä¸ªäºŒå…ƒç»„çš„æ‹“å±•ï¼Œè¯¥æ¡ä»¶é€šè¿‡è®¡ç®—è¿”å›å¸ƒå°”å€¼ã€‚å½“é€šè¿‡è¿™ä¸ªäºŒå…ƒç»„æ¥å®šä½åˆ°å¤šä¸ªTransitionçš„æ—¶å€™ï¼Œå°±éœ€è¦è¿™ä¸ªConditionæ¥åŠ¨æ€å†³å®šé€‰æ‹©ç‰¹å®šçš„Transitionæ¥å®ç°çŠ¶æ€çš„è½¬æ¢ã€‚ å½“äºŒå…ƒç»„å€¼å®šä½åˆ°ä¸€ä¸ªConditionçš„æ—¶å€™ï¼Œå¯ä»¥æŠŠConditionç†è§£ä¸ºæ˜¯å¦å…è®¸åˆ°è¾¾æŸä¸ªçŠ¶æ€ã€‚\nçŠ¶æ€æµè½¬è¿‡ç¨‹ çŠ¶æ€æœºå¯¹çŠ¶æ€è¿›è¡Œç»Ÿä¸€çš„ç®¡ç†ï¼ŒçŠ¶æ€æœºå°±éœ€è¦çŸ¥é“çŠ¶æ€æ˜¯æ€ä¹ˆæµè½¬çš„ï¼Œå“ªäº›çŠ¶æ€å¯ä»¥æµè½¬åˆ°å“ªäº›çŠ¶æ€ï¼Œä¾‹å¦‚å¾…æ”¯ä»˜å¯ä»¥æµè½¬åˆ°å·²æ”¯ä»˜ï¼Œä½†æ˜¯ä¸èƒ½å¤Ÿæµè½¬åˆ°å·²é€€æ¬¾ç­‰ï¼Œæ‰€ä»¥éœ€è¦ä¸€ä¸ªæå‰é…ç½®çŠ¶æ€æœºçš„è¿‡ç¨‹ã€‚ç®€å•çš„é…ç½®å°±æ˜¯å››å…ƒç»„ï¼š\n\u0026lt;å½“å‰çŠ¶æ€ï¼Œäº‹ä»¶ï¼Œç›®æ ‡çŠ¶æ€ï¼Œè½¬æ¢è¿‡ç¨‹Transition\u0026gt;\nå½“å‰äº‹åŠ¡çš„åˆå§‹çŠ¶æ€çŠ¶æ€ï¼ˆCurrent Stateï¼‰ï¼Œå‘ç”Ÿäº†æŸä¸ªäº‹ä»¶ï¼ˆEventï¼‰ï¼Œè§¦å‘äº†è½¬æ¢è¿‡ç¨‹ï¼ˆTransitionï¼‰æ¥å®ç°æµè½¬çŠ¶æ€åˆ°ç›®æ ‡çŠ¶æ€ï¼ˆTarget Stateï¼‰ã€‚\né…ç½®å¥½åï¼Œå°±ç­‰å¾…äº‹ä»¶æ¥è§¦å‘æŸå•ä¸ªäº‹ç‰©çš„çŠ¶æ€æµè½¬ã€‚çŠ¶æ€æœºå®ç°çŠ¶æ€çš„æµè½¬é€»è¾‘ä¹Ÿæ¯”è¾ƒç®€å•ï¼Œé¦–å…ˆæ˜¯äº‹ç‰©ï¼ˆä¾‹å¦‚æŸç¬”è®¢å•ï¼‰è‚¯å®šå‘ç”Ÿäº†æŸä¸ªäº‹ä»¶ï¼Œä¹‹åæ ¹æ®è¯¥äº‹ç‰©çš„å½“å‰çŠ¶æ€ï¼Œå°±æ„æˆäº†ä¸€ä¸ªäºŒå…ƒç»„ï¼š\n\u0026lt;å½“å‰çŠ¶æ€ï¼Œäº‹ä»¶\u0026gt;\nçŠ¶æ€æœºæ ¹æ®é…ç½®å°±å¯ä»¥æ‰¾åˆ°å¯¹åº”çš„ç›®æ ‡çŠ¶æ€ï¼ˆTarget Stateï¼‰ä»¥åŠè½¬æ¢ï¼ˆTransitionï¼‰ï¼ŒçŠ¶æ€æœºé€šè¿‡æ‰§è¡Œè¯¥Transitionçš„Actionæ¥å®ç°çŠ¶æ€çš„æµè½¬ã€‚å¦‚æœæ‰¾ä¸åˆ°è¯¥ç›®æ ‡çŠ¶æ€å’ŒTransitionï¼Œä»£è¡¨æ— æ³•è¿›è¡ŒçŠ¶æ€æµè½¬ã€‚\nå¤æ‚æ¦‚å¿µ åœ¨UML State Machineçš„æè¿°ä¸­ï¼Œè¿˜æœ‰è®¸å¤šå¤æ‚çš„æ¦‚å¿µï¼Œå¦‚ï¼šå±‚çº§çŠ¶æ€æœºï¼ˆHierarchical State Machinesï¼‰ï¼ŒçŠ¶æ€çš„åµŒå¥—ï¼ˆsubstateï¼‰ï¼ŒçŠ¶æ€çš„å¹¶è¡Œï¼ˆparallelï¼Œforkï¼Œjoinï¼‰ï¼ŒåŒºåŸŸï¼ˆRegionï¼‰ç­‰ç­‰ã€‚è¿™äº›æ¦‚å¿µéƒ½éå¸¸å¤æ‚ï¼Œç°å®ä¸­è¿˜æœªæ¥è§¦è¿‡ï¼Œç†è§£ä¸æ·±ï¼Œå°±ä¸åœ¨è¿™é‡Œè§£é‡Šæè¿°äº†ã€‚ å¯ä»¥å‚è€ƒä¸‹é¢çš„æ–‡æ¡£ï¼š\nSpringStateMachineæ–‡æ¡£ï¼šstate-machine-conceptsï¼ˆçœ‹å…¶é™„å½•ï¼‰ UML State Machine æ€»ç»“ æœ‰é™çŠ¶æ€æœºæŠŠçŠ¶æ€ç®¡ç†ç›¸å…³çš„è¡Œä¸ºæŠ½è±¡æˆï¼šçŠ¶æ€Stateã€è½¬å˜Transitionã€äº‹ä»¶Eventã€åŠ¨ä½œActionã€å®ˆæŠ¤æ¡ä»¶Conditionç­‰æ¦‚å¿µã€‚é€šè¿‡å¯¹çŠ¶æ€æœºè¿›è¡Œé…ç½®ï¼Œæ¥æè¿°çŠ¶æ€åŠäº‹ä»¶è§¦å‘çš„æµè½¬è·¯çº¿ï¼Œä»¥åŠå®ç°æµè½¬çš„Transitionã€‚ åº”ç”¨çŠ¶æ€æœºï¼Œä¸»è¦æ˜¯ä¸ºäº†å¯¹çŠ¶æ€è¿›è¡Œé›†ä¸­ç®¡ç†ï¼Œæ˜ç¡®çŠ¶æ€çš„æµè½¬ï¼Œé¿å…æµè½¬ä»£ç çš„æ•£ä¹±ï¼Œè¿›è€Œæé«˜äº†å¯ç»´æŠ¤æ€§ã€‚\né™„å½• å‚è€ƒ ç»´åŸºç™¾ç§‘ï¼šæœ‰é™çŠ¶æ€æœº SpringStateMachineæ–‡æ¡£ï¼šstate-machine-concepts UML State Machine å®ç°ä¸€ä¸ªçŠ¶æ€æœºå¼•æ“ï¼Œæ•™ä½ çœ‹æ¸…DSLçš„æœ¬è´¨ ","date":"2024-08-16T10:21:36+08:00","image":"https://gloryjie.github.io/p/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%AF%87%E4%B8%80%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3/cover_hubc0c84fe558bd0a18fe5845534db8b92_2319399_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/%E7%8A%B6%E6%80%81%E6%9C%BA%E7%AF%87%E4%B8%80%E6%A6%82%E5%BF%B5%E7%90%86%E8%A7%A3/","title":"çŠ¶æ€æœºç¯‡ä¸€ï¼šæ¦‚å¿µç†è§£"},{"content":" å°é¢æ˜¯ã€Šè¯›ä»™ã€‹åŠ¨æ¼«ä¸­çš„å°ç™½ï¼Œç™½ç‹\nJTSï¼Œå…¨ç§°Java Topology Suiteï¼Œæ˜¯ä¸€ä¸ªç”¨äºåˆ›å»ºå’Œæ“ä½œå‘é‡å‡ ä½•çš„Javaåº“ã€‚æä¾›äº†å¯¹å‡ ä½•æ¨¡å‹çš„æŠ½è±¡ï¼Œä»¥åŠå„ç§ç©ºé—´æ“ä½œå’Œç©ºé—´å…³ç³»åˆ¤æ–­ï¼Œéå¸¸å¼ºå¤§ã€‚\nå¼•å…¥jaråŒ… JTSæœ‰å¤šä¸ªæ¨¡å—ï¼Œè¿™é‡Œåªä½¿ç”¨äº†æ ¸å¿ƒçš„æ¨¡å—ã€‚\njts-coreï¼šæä¾›å‡ ä½•æ¨¡å‹çš„æŠ½è±¡ã€ç©ºé—´æ“ä½œã€ç©ºé—´å…³ç³»åˆ¤æ–­ç®—æ³•ç­‰ jts-io-commonï¼šæä¾›å„ç§æ ¼å¼æè¿°å‡ ä½•æ¨¡å‹çš„è¾“å…¥è¾“å‡ºåŒ…ï¼Œå¦‚å¯¹WKTã€WKBç­‰æ ¼å¼ 1 2 3 4 5 6 7 8 9 10 11 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.locationtech.jts\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jts-core\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.19.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;org.locationtech.jts.io\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;jts-io-common\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.19.0\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; å‡ ä½•æ¨¡å‹ JTSæä¾›äº†å¸¸è§çš„é›†åˆæ¨¡å‹æŠ½è±¡ï¼Œå¹¶ä¸”å„å…·ç‰¹ç‚¹ã€‚\næ¨¡å‹ å®šä¹‰ å¸¸è§åº”ç”¨ ç‚¹ï¼ˆPointï¼‰ è¡¨ç¤ºç©ºé—´ä¸­çš„å•ä¸ªä½ç½®ï¼Œç”±ä¸€å¯¹x,yåæ ‡è¡¨ç¤º è¡¨ç¤ºå…´è¶£ç‚¹ã€äº‹ä»¶ä½ç½®ç­‰ å¤šç‚¹ï¼ˆMultiPointï¼‰ ç”±å¤šä¸ªç‹¬ç«‹çš„ç‚¹ç»„æˆçš„å‡ ä½•å¯¹è±¡ è¡¨ç¤ºå¤šä¸ªç›¸å…³ä½†åˆ†æ•£çš„ä½ç½®ï¼Œå¦‚è¿é”åº—åˆ†å¸ƒï¼Œå¤šä¸ªä¸åŒäººä½ç½® çº¿ï¼ˆLineStringï¼‰ ç”±ä¸€ç³»åˆ—ç‚¹ç»„æˆçš„ä¸€ç»´å‡ ä½•å¯¹è±¡ï¼Œæœ‰èµ·ç‚¹å’Œç»ˆç‚¹ï¼Œä¸­é—´å¯ä»¥æœ‰ä»»æ„æ•°é‡çš„ç‚¹ è¡¨ç¤ºé“è·¯ã€æ²³æµç­‰çº¿æ€§ç‰¹å¾ å¤šçº¿ï¼ˆMultiLineStringï¼‰ ç”±å¤šä¸ªä¸ç›¸è¿çš„LineStringç»„æˆçš„å‡ ä½•å¯¹è±¡ è¡¨ç¤ºå¤æ‚çš„é“è·¯ç½‘ç»œã€ç­‰é«˜çº¿ç­‰ å¤šè¾¹å½¢ï¼ˆPolygonï¼‰ ç”±ä¸€ç³»åˆ—é¦–å°¾ç›¸è¿çš„çº¿æ®µå›´æˆçš„å¹³é¢åŒºåŸŸï¼ˆå¯ä»¥æœ‰å†…éƒ¨ç©ºæ´ï¼‰ è¡¨ç¤ºè¡Œæ”¿åŒºåˆ’ã€å»ºç­‘ç‰©è½®å»“ç­‰ å¤šå¤šè¾¹å½¢ï¼ˆMultiPolygonï¼‰ ç”±å¤šä¸ªç‹¬ç«‹çš„Polygonç»„æˆçš„å‡ ä½•å¯¹è±¡ï¼Œå¯ä»¥è¡¨ç¤ºä¸ç›¸è¿çš„å¤šä¸ªåŒºåŸŸ è¡¨ç¤ºç¾¤å²›ã€å¤æ‚çš„è¡Œæ”¿åŒºåˆ’ å‡ ä½•é›†åˆï¼ˆGeometryCollectionï¼‰ å¯ä»¥åŒ…å«ä»»æ„ç±»å‹å‡ ä½•å¯¹è±¡çš„é›†åˆï¼Œæœ€çµæ´»çš„å‡ ä½•ç±»å‹ï¼Œå¯ä»¥æ··åˆåŒ…å«ç‚¹ã€çº¿ã€é¢ç­‰ è¡¨ç¤ºå¤æ‚çš„ç©ºé—´åœºæ™¯ï¼Œå¦‚åŒ…å«å¤šç§ç±»å‹è¦ç´ çš„åœ°å›¾ JTSä¸­çš„å„å‡ ä½•æ¨¡å‹å¯¹è±¡å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°é¡¶å±‚çš„å‡ ä½•å¯¹è±¡Geometryï¼Œæ‰€æœ‰å®é™…çš„å‡ ä½•å¯¹è±¡éƒ½ç»§æ‰¿è¯¥å¯¹è±¡ã€‚ ç©ºé—´æè¿°æ ¼å¼-WKB WKTï¼ˆWell-Know Textï¼‰æ ¼å¼æ˜¯ä¸€ç§æ–‡æœ¬æ ¼å¼ï¼Œç”¨äºæè¿°äºŒç»´å’Œä¸‰ç»´å‡ ä½•å¯¹è±¡çš„ç©ºé—´ç‰¹å¾ã€‚ WKTçš„åŸºæœ¬è¯­æ³•æ ¼å¼å¦‚ä¸‹ï¼š\n1 å‡ ä½•æ¨¡å‹ç±»å‹ (æ¨¡å‹æ•°æ®) ç¤ºä¾‹å¦‚ä¸‹æ‰€ç¤º\n1 2 3 ç‚¹ï¼šPOINT (282 455) çº¿ï¼šLINESTRING (260 250, 485 248, 520 380) å¤šè¾¹å½¢ï¼šPOLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390)) JTSæ”¯æŒå¯¹è¯¥æ ¼å¼çš„è¯»å†™æ“ä½œï¼Œä¸»è¦æ˜¯ä¸¤ä¸ªå¯¹è±¡WKTReaderå’ŒWKTWriterï¼Œä»£ç ç¤ºä¾‹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 // è¯»å–wktæè¿°çš„å‡ ä½•å¯¹è±¡ WKTReader wktReader = new WKTReader(); Geometry point = wktReader.read(\u0026#34;POINT (282 455)\u0026#34;); Geometry line = wktReader.read(\u0026#34;LINESTRING (260 250, 485 248, 520 380)\u0026#34;); Geometry polygon = wktReader.read(\u0026#34;POLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390))\u0026#34;); // è¾“å‡ºå‡ ä½•å¯¹è±¡çš„wktæè¿° WKTWriter wktWriter = new WKTWriter(); System.out.println(wktWriter.write(point)); System.out.println(wktWriter.write(line)); System.out.println(wktWriter.write(polygon)); ç©ºé—´å…³ç³» JTSä¸­çš„ç©ºé—´å…³ç³»æ˜¯åŸºäºDE-9IMï¼ˆDimensionally Extended Nine-Intersection Modelï¼‰æ¨¡å‹å®šä¹‰çš„ï¼Œè¿™é‡Œåˆ—ä¸¾å¸¸è§çš„ç©ºé—´å…³ç³»\nç©ºé—´å…³ç³» å®šä¹‰ ç›¸ç­‰ (Equals) ä¸¤ä¸ªå‡ ä½•å¯¹è±¡åœ¨æ‹“æ‰‘ä¸Šç›¸ç­‰ ç›¸ç¦» (Disjoint) ä¸¤ä¸ªå‡ ä½•å¯¹è±¡æ²¡æœ‰ä»»ä½•å…±åŒç‚¹ ç›¸äº¤ (Intersects) ä¸¤ä¸ªå‡ ä½•å¯¹è±¡æœ‰è‡³å°‘ä¸€ä¸ªå…±åŒç‚¹ å†…å« (Within) å‡ ä½•å¯¹è±¡Aå®Œå…¨ä½äºå‡ ä½•å¯¹è±¡Bå†…éƒ¨ åŒ…å« (Contains) å‡ ä½•å¯¹è±¡Aå®Œå…¨åŒ…å«å‡ ä½•å¯¹è±¡B ä»¥è¯¥å›¾å½¢ä¸ºä¾‹ï¼Œä¸¤ä¸ªå¤šè¾¹å½¢çš„å…³ç³»åˆ¤æ–­çš„ä»£ç ç¤ºä¾‹ 1 2 3 4 5 6 7 8 9 WKTReader wktReader = new WKTReader(); Geometry geometryA = wktReader.read(\u0026#34;POLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390))\u0026#34;); Geometry geometryB = wktReader.read(\u0026#34;POLYGON ((500 420, 430 360, 530 260, 500 420))\u0026#34;); System.out.println(\u0026#34;Equal: \u0026#34; + geometryA.equals(geometryB)); System.out.println(\u0026#34;Disjoint: \u0026#34; + geometryA.disjoint(geometryB)); System.out.println(\u0026#34;Intersects: \u0026#34; + geometryA.intersects(geometryB)); System.out.println(\u0026#34;Within: \u0026#34; + geometryA.within(geometryB)); System.out.println(\u0026#34;Contains: \u0026#34; + geometryA.contains(geometryB)); ç©ºé—´æ“ä½œ JTSæä¾›äº†ä¸°å¯Œçš„ç©ºé—´æ“ä½œåŠŸèƒ½ï¼Œç”¨äºå¤„ç†å’Œåˆ†æå‡ ä½•å¯¹è±¡ã€‚è¿™é‡Œåˆ—ä¸¾å¸¸è§çš„å‡ ç§\nç©ºé—´æ“ä½œ å®šä¹‰ ç›¸äº¤ (Intersection) è®¡ç®—ä¸¤ä¸ªå‡ ä½•å¯¹è±¡çš„å…±åŒéƒ¨åˆ† å¹¶é›† (Union) åˆå¹¶ä¸¤ä¸ªæˆ–å¤šä¸ªå‡ ä½•å¯¹è±¡ å·®é›† (Difference) ä»ä¸€ä¸ªå‡ ä½•å¯¹è±¡ä¸­å‡å»å¦ä¸€ä¸ªå‡ ä½•å¯¹è±¡ ä»¥è¯¥å›¾ä¸ºä¾‹ï¼Œæ“ä½œç¤ºä¾‹ä»£ç å¦‚ä¸‹ 1 2 3 4 5 6 7 WKTReader wktReader = new WKTReader(); Geometry geometryA = wktReader.read(\u0026#34;POLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390))\u0026#34;); Geometry geometryB = wktReader.read(\u0026#34;POLYGON ((500 420, 430 360, 530 260, 500 420))\u0026#34;); System.out.println(\u0026#34;Intersection: \u0026#34; + wktWriter.write(geometryA.intersection(geometryB))); System.out.println(\u0026#34;Union: \u0026#34; + wktWriter.write(geometryA.union(geometryB))); System.out.println(\u0026#34;Difference: \u0026#34; + wktWriter.write(geometryA.difference(geometryB))); ä¸‹é¢æ˜¯Unionåˆå¹¶åçš„æ•ˆæœ ç©ºé—´ç´¢å¼• æœ€å°å¤–æ¥çŸ©å½¢ï¼ˆMBRï¼‰ æœ€å°å¤–æ¥çŸ©å½¢MBR (Minimum Bounding Retangle)ï¼Œæ˜¯èƒ½å¤Ÿå®Œå…¨åŒ…å«ä¸€ä¸ªå‡ ä½•å¯¹è±¡çš„æœ€å°çŸ©å½¢ã€‚ å¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¿™ä¸ªè§„åˆ™çš„çŸ©å½¢å°±æ˜¯è¯¥å¤šè¾¹å½¢çš„MBRè¡¨ç¤ºã€‚ è¡¨ç¤ºMBRéå¸¸ç®€å•ï¼Œåªéœ€è¦çŸ¥é“ä»–çš„å·¦ä¸‹è§’å’Œå³ä¸Šè§’ï¼Œé‚£ä¹ˆå°±å¯ä»¥çŸ¥é“è¿™ä¸ªMBRå›¾å½¢äº†ã€‚å¦‚ä¸‹å›¾æ‰€ç¤º çŸ¥é“äº†è¿™ä¸ªæœ€å°å¤–æ¥çŸ©å½¢æœ‰ä»€ä¹ˆç”¨ï¼Ÿ è¿™é‡Œæœ‰ä¸ªæ–­è¨€ï¼šå¦‚æœç‚¹ä¸åœ¨è¿™ä¸ªMBRå†…äº†ï¼Œé‚£ä¹ˆè‚¯å®šä¸åœ¨è¿™ä¸ªå¤šè¾¹å½¢å†…ã€‚æ‰€ä»¥æŠŠç‚¹å’ŒMBRè¿›è¡Œæ¯”è¾ƒï¼Œå°±èƒ½å¤Ÿå¿«é€Ÿæ’é™¤ä¸å¯èƒ½æœ‰å…³ç³»çš„å¤šè¾¹å½¢å¯¹è±¡ã€‚\né‚£ä¹ˆå¦‚ä½•å¿«é€Ÿçš„åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨MBRä¸­ï¼Ÿæ¯”è¾ƒåæ ‡å€¼çš„å¤§å°å°±å¯ä»¥äº†ã€‚ç¤ºä¾‹ä»£ç å¦‚ä¸‹\n1 2 3 4 mbr.getLngMin() \u0026lt;= point.getLng() \u0026amp;\u0026amp; mbr.getLngMax() \u0026gt;= point.getLng() \u0026amp;\u0026amp; mbr.getLatMin() \u0026lt;= point.getLat() \u0026amp;\u0026amp; mbr.getLatMax() \u0026gt;= point.getLat() ç»¼ä¸Šï¼ŒMBRç”¨ç®€å•çš„çŸ©å½¢æ¥è¿‘ä¼¼è¡¨ç¤ºå¤æ‚çš„å‡ ä½•å½¢çŠ¶ï¼Œå°†å¤æ‚çš„ç©ºé—´å…³ç³»ç®€åŒ–ä¸ºçŸ©å½¢ä¹‹é—´çš„å…³ç³»ã€‚é€šè¿‡MBRè¿™ä¸€å±‚çš„åˆæ­¥ç­›é€‰ï¼Œå°±èƒ½å¤Ÿå¿«é€Ÿæ’é™¤ä¸å¯èƒ½æœ‰å…³ç³»çš„å¤šè¾¹å½¢å¯¹è±¡ã€‚\nåœ¨JTSä¸­ï¼ŒEnvelopeå¯¹è±¡æ¥è¡¨ç¤ºMBRã€‚ä»£ç ç¤ºä¾‹å¦‚ä¸‹\n1 2 3 4 5 6 7 8 WKTReader wktReader = new WKTReader(); Geometry geometryA = wktReader.read(\u0026#34;POLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390))\u0026#34;); Envelope envelope = geometryA.getEnvelopeInternal(); System.out.println(envelope.getMaxX()); System.out.println(envelope.getMaxY()); System.out.println(envelope.getMinX()); System.out.println(envelope.getMinY()); ç©ºé—´ç´¢å¼• ä¸Šè¿°æ„å»ºMBRå¯ä»¥ç†è§£ä¸ºç®€å•ç´¢å¼•çš„ä¸€ç§ï¼Œå®é™…ä¸Šæœ‰å¤æ‚çš„ç©ºé—´ç´¢å¼•ã€‚å¸¸è§ç©ºé—´ç´¢å¼•æœ‰\nRæ ‘ï¼ˆR-treeï¼‰ï¼šå¹³è¡¡æ ‘ï¼Œé€‚ç”¨äºå¤šç»´ç©ºé—´æ•°æ®ï¼ˆç±»ä¼¼ä¸€ç»´çš„B+æ ‘ï¼‰ å››å‰æ ‘ï¼ˆQuad-treeï¼‰ï¼šå°†äºŒç»´ç©ºé—´é€’å½’åœ°åˆ†ä¸ºå››ä¸ªè±¡é™ ç½‘æ ¼ï¼ˆGridï¼‰ï¼šå°†ç©ºé—´åˆ’åˆ†ä¸ºè§„åˆ™çš„ç½‘æ ¼å•å…ƒ JTSæä¾›äº†Quadtreeï¼ˆå››å‰æ ‘ï¼‰ã€STRtreeï¼ˆåŸºäºRæ ‘çš„å˜ä½“ï¼‰çš„å®ç°ã€‚æ„å»ºRæ ‘ç©ºé—´ç´¢å¼•çš„ç¤ºä¾‹ä»£ç å¦‚ä¸‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 WKTReader wktReader = new WKTReader(); Geometry geometryA = wktReader.read(\u0026#34;POLYGON ((320 390, 370 330, 470 360, 460 430, 375 432, 320 390))\u0026#34;); Geometry geometryB = wktReader.read(\u0026#34;POLYGON ((500 420, 430 360, 530 260, 500 420))\u0026#34;); STRtree rtree = new STRtree(); // å‘Ræ ‘ç§æ·»åŠ MBRï¼Œå’Œè‡ªå·±çš„æ•°æ® rtree.insert(geometryA.getEnvelopeInternal(), \u0026#34;Polygon-A\u0026#34;); rtree.insert(geometryB.getEnvelopeInternal(), \u0026#34;Polygon-B\u0026#34;); rtree.build(); // ç‚¹åªåœ¨Polygon-Aä¸­ System.out.println(rtree.query(wktReader.read(\u0026#34;POINT (337 391)\u0026#34;).getEnvelopeInternal())); // ç‚¹åªåœ¨Polygon-Bä¸­ System.out.println(rtree.query(wktReader.read(\u0026#34;POINT (496 390)\u0026#34;).getEnvelopeInternal())); // ç‚¹åœ¨Polygon-Aå’ŒPolygon-Bçš„äº¤é›†ä¸­ System.out.println(rtree.query(wktReader.read(\u0026#34;POINT (452 367)\u0026#34;).getEnvelopeInternal())); æ€»ç»“ JTSè¿˜æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œæä¾›äº†å‡ ä¹æ‰€æœ‰çš„ç©ºé—´è®¡ç®—ä¸Šçš„ä¸œè¥¿ã€‚åœ¨å®é™…åº”ç”¨è¿‡ç¨‹ä¸­ï¼Œéœ€è¦åŠ å¿«ä¸€äº›è®¡ç®—è¿‡ç¨‹ï¼Œå°±éœ€è¦ä½¿ç”¨ä¸Šç©ºé—´ç´¢å¼•ï¼Œä¸€èˆ¬éƒ½æ˜¯åœ¨å†…å­˜ä¸­æ„å»ºç´¢å¼•æ ‘ã€‚åœ¨JTSä¹‹ä¸Šï¼Œè¿˜æœ‰ä¸ªåŸºäºJTSçš„GeoToolsçš„å·¥å…·ï¼Œè¿™ä¸ªæ˜¯æ›´ä¸ºå¼ºå¤§ã€‚è¿™ä¸€å—ç”±äºåªæ˜¯å¤„äºåº”ç”¨å±‚é¢ï¼Œæ¶‰åŠçš„ä¸€äº›ç®—æ³•ä¸Šçš„è®¡ç®—ç­‰å°±ä¸è¿‡äºæ·±ç©¶ï¼Œæ¯•ç«Ÿä¸“ä¸šæ€§è¾ƒå¼ºã€‚\né™„å½• å‚è€ƒ Java Topology Suite (JTS) GISåŸç†åœ¨çº¿æ•™ç¨‹ ","date":"2024-07-17T20:25:28+08:00","image":"https://gloryjie.github.io/p/javatopologysuite%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/cover_hubaffd4205b0b02afbafe504f2ba8b6c7_2286570_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/javatopologysuite%E7%9A%84%E7%AE%80%E5%8D%95%E4%BD%BF%E7%94%A8/","title":"JavaTopologySuiteçš„ç®€å•ä½¿ç”¨"},{"content":" å°é¢ä¸ºå›½æ¼«ã€Šè¯›ä»™ã€‹ä¸­çš„å¥³ä¸» é™†é›ªçª\nCopyOnWriteï¼ˆç¼©å†™COWï¼‰ æœºåˆ¶æ˜¯ä¸€ç§å¹¶å‘ç¼–ç¨‹çš„å¸¸ç”¨ç­–ç•¥ï¼Œç”¨äºå¤„ç†æ•°æ®é›†åˆåœ¨è¯»å†™æ“ä½œåŒæ—¶å‘ç”Ÿæ—¶çš„ä¸€è‡´æ€§é—®é¢˜ã€‚å®ƒçš„åŸºæœ¬æ€æƒ³æ˜¯æ¯æ¬¡ä¿®æ”¹æ“ä½œï¼ˆå¦‚æ·»åŠ æˆ–åˆ é™¤å…ƒç´ ï¼‰éƒ½ä¼šåˆ›å»ºé›†åˆçš„ä¸€ä¸ªæ–°å‰¯æœ¬ï¼Œä»è€Œç¡®ä¿è¯»æ“ä½œå§‹ç»ˆåœ¨ä¸å˜çš„é›†åˆè§†å›¾ä¸Šæ‰§è¡Œã€‚\nCOWå·¥ä½œæœºåˆ¶ è¯»æ“ä½œï¼š æ‰€æœ‰è¯»æ“ä½œï¼ˆå¦‚ get()ã€size()ï¼‰åœ¨å½“å‰ä¸å˜çš„æ•°ç»„å‰¯æœ¬ä¸Šè¿›è¡Œï¼Œä¸éœ€è¦åŠ é”ï¼Œå› æ­¤æ€§èƒ½éå¸¸é«˜ã€‚ å†™æ“ä½œï¼š å†™æ“ä½œï¼ˆå¦‚ add()ã€remove()ï¼‰ä¼šå¤åˆ¶å½“å‰æ•°ç»„ï¼Œè¿›è¡Œä¿®æ”¹ï¼Œå¹¶å°†ä¿®æ”¹åçš„æ–°æ•°ç»„è®¾ç½®ä¸ºåº•å±‚æ•°ç»„ã€‚ å†™æ“ä½œéœ€è¦åŠ é”ä»¥ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œä½†ç”±äºå†™æ“ä½œæ˜¯åœ¨æ–°æ•°ç»„å‰¯æœ¬ä¸Šè¿›è¡Œçš„ï¼Œå› æ­¤ä¸ä¼šé˜»å¡è¯»æ“ä½œã€‚ äº†è§£äº†COWæœºåˆ¶åï¼Œå°±æ˜ç™½è¯»æ“ä½œæ˜¯å¿«è€Œè½»ï¼Œå†™æ“ä½œå°±å¾ˆé‡ã€‚æ‰€ä»¥å°±ä¼šæœ‰ä»¥ä¸‹çš„ç‰¹ç‚¹\nå†…å­˜å¼€é”€ï¼šç”±äºæ¯æ¬¡å†™æ“ä½œéƒ½ä¼šåˆ›å»ºæ•°ç»„çš„å‰¯æœ¬ï¼Œå› æ­¤åœ¨å†™æ“ä½œé¢‘ç¹çš„åœºæ™¯ä¸­ä¼šäº§ç”Ÿè¾ƒé«˜çš„å†…å­˜å¼€é”€å’Œåƒåœ¾å›æ”¶è´Ÿæ‹…ã€‚ ä¸€è‡´æ€§ï¼šåœ¨ CopyOnWrite é›†åˆä¸­ï¼Œè¿­ä»£å™¨è¿”å›çš„å…ƒç´ å¯èƒ½æ˜¯è¿‡æ—¶çš„ï¼Œå› ä¸ºè¿­ä»£å™¨éå†çš„æ˜¯å¿«ç…§ï¼Œä¸ä¼šåæ˜ æœ€æ–°çš„ä¿®æ”¹ã€‚ COWé€šå¸¸é€‚ç”¨äºè¯»å¤šå†™å°‘çš„åœºæ™¯\né€‚ç”¨åœºæ™¯ï¼šCopyOnWrite æœºåˆ¶é€‚ç”¨äºè¯»æ“ä½œé¢‘ç¹è€Œå†™æ“ä½œè¾ƒå°‘çš„åœºæ™¯ï¼Œä¾‹å¦‚ç¼“å­˜ã€ç™½åå•å’Œé»‘åå•ç­‰é…ç½®ã€‚ Javaä¸­çš„COWå®¹å™¨ Javaä¸­CopyOnWriteæœºåˆ¶å…·ä½“å®¹å™¨æœ‰ä¸¤ä¸ª\nCopyOnWriteArrayList CopyOnWriteArraySetï¼šåŸºäºCopyOnWriteArrayListæ¥å®ç°çš„ æ‰€ä»¥ä¸»è¦çœ‹CopyOnWriteArrayListçš„å®ç°ã€‚\nå±æ€§åªæœ‰ä¸¤ä¸ªï¼Œåº•å±‚å°±æ˜¯ä¸€ä¸ªæ•°ç»„ï¼Œä½¿ç”¨ReentrantLockæ¥è¿›è¡Œå†™æ•°ç»„çš„ä¿æŠ¤ã€‚\n1 2 3 4 5 /** The lock protecting all mutators */ final transient ReentrantLock lock = new ReentrantLock(); /** The array, accessed only via getArray/setArray. */ private transient volatile Object[] array; ä¸‹é¢æ˜¯addæ–¹æ³•çš„é€»è¾‘ï¼Œå®ç°æ¯”è¾ƒç®€å•ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /** * Appends the specified element to the end of this list. * * @param e element to be appended to this list * @return {@code true} (as specified by {@link Collection#add}) */ public boolean add(E e) { final ReentrantLock lock = this.lock; // å†™æ“ä½œåŠ é”ä¿æŠ¤ lock.lock(); try { // è·å–æ•°æ®å¿«ç…§ Object[] elements = getArray(); int len = elements.length; Object[] newElements = Arrays.copyOf(elements, len + 1); newElements[len] = e; setArray(newElements); return true; } finally { lock.unlock(); } } å†æ¥çœ‹çœ‹getçš„é€»è¾‘ã€‚æ›´ç®€å•äº†ï¼Œå’Œå¹³æ—¶è®¿é—®ä¸€ä¸ªæ•°æ®å…ƒç´ ä¸€æ ·ï¼Œä¸éœ€è¦é”çš„ä¿æŠ¤ã€‚è¿™é‡Œéœ€è¦æ³¨æ„çš„å°±æ˜¯å…ˆé€šè¿‡getArrayè·å–äº†æ•°æ®å¿«ç…§ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 /** * {@inheritDoc} * * @throws IndexOutOfBoundsException {@inheritDoc} */ public E get(int index) { return get(getArray(), index); } final Object[] getArray() { return array; } å¯¹æ¯”Java8å’Œ21çš„å®ç°å˜åŒ– Java8å’ŒJava21ä¸­çš„å®ç°å˜åŒ–ä¸å¤§ï¼Œä¸»è¦è¿˜æ˜¯åœ¨ä½¿ç”¨é”çš„å˜åŒ–ä¸Šã€‚\nJava8ï¼šä½¿ç”¨ReentrantLock Java21ï¼šä½¿ç”¨synchronizedå…³é”®å­— è¿™é‡Œè´´ä¸€ä¸‹Java21ä¸­çš„addä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 /** * The lock protecting all mutators. (We have a mild preference * for builtin monitors over ReentrantLock when either will do.) */ final transient Object lock = new Object(); /** * Appends the specified element to the end of this list. * * @param e element to be appended to this list * @return {@code true} (as specified by {@link Collection#add}) */ public boolean add(E e) { synchronized (lock) { Object[] es = getArray(); int len = es.length; es = Arrays.copyOf(es, len + 1); es[len] = e; setArray(es); return true; } } å¯ä»¥çœ‹åˆ°lockå±æ€§å‘ç”Ÿäº†å˜åŒ–ã€‚å±æ€§ä¸Šè¾¹çš„æ³¨é‡Š\nWe have a mild preference for builtin monitors over ReentrantLock when either will do.\nä¹Ÿå°±æ˜¯ä½œè€…æ›´å€¾å‘äºä½¿ç”¨synchronizedã€‚ä½†æ˜¯åœ¨Java21ä¸­ï¼Œä½¿ç”¨synchronizedä¼šé€ æˆè¿è¡ŒVirtual Threadçš„Carrier Threadè¢«pinnedä½çš„é—®é¢˜ã€‚ä¸çŸ¥é“åé¢ä¼šä¸ä¼šæ”¹å›æ¥ä½¿ç”¨ReentrantLockã€‚\né™„å½• å‚è€ƒ ","date":"2024-06-13T20:12:48+08:00","image":"https://gloryjie.github.io/p/java-copyonwrite%E5%AE%B9%E5%99%A8/cover_hu0e51770fe8d4da95ee6ceb0cbcfd719c_1732175_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/java-copyonwrite%E5%AE%B9%E5%99%A8/","title":"Java CopyOnWriteå®¹å™¨"},{"content":" å°é¢æ˜¯éŸ©å›½çš„Arinï¼Œä¸‹é¢æ˜¯æŠ–éŸ³ç»å¸¸åˆ·åˆ°çš„ä¸€ä¸ªè£…æ‰®\nè¿™é‡Œç›´æ¥ä½¿ç”¨SDKMANè¿›è¡Œjdk21çš„ä¸‹è½½ã€‚ï¼ˆå®‰åˆ©SDKManè¿™ä¸ªå·¥å…·ï¼Œæœ¬åœ°ç”¨æ¥åˆ‡æ¢å„ç‰ˆæœ¬sdkæ–¹ä¾¿ï¼‰\n1 sdk install java 22.0.1-oracle æ­£å¼å‘å¸ƒçš„ï¼ˆéé¢„è§ˆï¼‰æ–°ç‰¹æ€§ã€‚å¹¶å¯¹è¯­æ³•å±‚é¢çš„ï¼Œä¹Ÿå°±æ˜¯æ ¸å¿ƒJavaåº“ç›¸å…³çš„åšä¸ªç®€å•è®°å½•ã€‚\nJEP åˆ†ç±» è™šæ‹Ÿçº¿ç¨‹ æ ¸å¿ƒ Java åº“ æœ‰åºé›†åˆ æ ¸å¿ƒ Java åº“ Record æ¨¡å¼ æ ¸å¿ƒ Java åº“ switch æ¨¡å¼åŒ¹é… æ ¸å¿ƒ Java åº“ åˆ†ä»£ ZGC HotSpot å¼ƒç”¨ Windows 32 ä½ x86 ç«¯å£ HotSpot å‡†å¤‡ç¦æ­¢åŠ¨æ€åŠ è½½ä»£ç† HotSpot å¯†é’¥å°è£…æœºåˆ¶ API å®‰å…¨åº“ æœ‰åºé›†åˆ JEP 431\nå¯¹äºæœ‰åºé›†åˆï¼Œï¼Œå¦‚Listï¼ˆArrayListã€LinkListç­‰ï¼‰ã€Deqeueã€SortedSetç­‰ï¼Œæ²¡æœ‰ä¸€ä¸ªå…±åŒçš„æ“ä½œè¯­ä¹‰apiåŒºé˜ŸåŒç«¯å°±è¡Œæ“ä½œã€‚ä¸‹é¢è·ç¦»å–ç¬¬ä¸€ä¸ªã€æœ€ä¼˜ä¸€ä¸ªå…ƒç´ çš„å½“å‰æ–¹å¼ã€‚\nCollection First element Last element List list.get(0) list.get(list.size() - 1) Deque deque.getFirst() deque.getLast() SortedSet sortedSet.first() sortedSet.last() LinkedHashSet linkedHashSet.iterator().next() // missing å®é™…å¼€å‘ä¸­æœ€å¸¸è§çš„å°±æ˜¯list.get(0)ã€list.get(list.size() - 1)ã€‚åœ¨ä¸Šè¿°èƒŒæ™¯ä¸‹ï¼Œæ–°å¢äº†ä¸‰ä¸ªæ¥å£ï¼šSequencedCollectionã€SequencedSetã€SequencedMapã€‚ä¸‹é¢æ¥çœ‹ä¸‹è¿™ä¸‰ä¸ªæ¥å£çš„ç›¸å…³å®šä¹‰ã€‚\nä¸‹é¢æ˜¯ä¸‰ä¸ªæ¥å£åœ¨é›†åˆæ¡†æ¶ä½“ç³»ä¸­çš„å…³ç³»ã€‚ SequencedCollectionæ¥å£å®šä¹‰å¦‚ä¸‹ï¼Œéƒ½æ˜¯å¯¹äºé¦–å°¾æ“ä½œçš„æ–¹æ³•ï¼Œè¿˜æœ‰ä¸€ä¸ªåè½¬é¡ºåºçš„æ“ä½œã€‚ SequencedSetç»§æ‰¿è‡ªSequenceCollectionï¼Œé‡å†™äº†reversedæ–¹æ³•çš„è¿”å›å€¼è€Œå·²ã€‚ SequencedMapæ˜¯è‡ªå·±å•ç‹¬å®šä¹‰çš„ï¼Œéœ€è¦ç•™æ„ä¸¤ä¸ªæ–¹æ³•çš„è¿”å›å€¼\nsequencedKeySetè¿”å›SequencedSet sequenedValuesè¿”å›SequencdCollection å¯¹äºé¦–å°¾æ“ä½œå°±ä¸éœ€è¦è‡ªå·±å»éå†æˆ–è€…æŒ‡å®šindexäº†ï¼Œè¿˜åŠ å¤šäº†ä¸€ä¸ªreverseæ“ä½œã€‚\nRecordæ¨¡å¼ JEP440\nå¯¹äºRecordåœ¨æ—¥å¸¸ä½¿ç”¨è€…ï¼Œä¸ªäººè¿˜æ²¡æœ‰ä½¿ç”¨ä¸Šï¼ˆæ—¥å¸¸å·¥ä½œè¿˜åœ¨Java8ï¼‰ï¼Œæ„Ÿè§¦ä¸æ˜¯å¾ˆæ·±ï¼Œå…ˆä¸ç ”ç©¶ã€‚\nswitchæ”¯æŒæ•°æ®ç±»å‹åŒ¹é… ç›´è§‚æ„Ÿå—å°±æ˜¯æ”¯æŒäº†æ•°æ®ç±»å‹åŒ¹é…ï¼Œè¿˜æ”¯æŒnullåŒ¹é…ğŸ‘ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 public class Main { public static void main(String[] args) { System.out.println(getTypeStr(1)); System.out.println(getTypeStr(\u0026#34;hello\u0026#34;)); System.out.println(getTypeStr(12.12d)); System.out.println(getTypeStr(123L)); System.out.println(getTypeStr(true)); } public static String getTypeStr(Object o) { return switch (o) { case null -\u0026gt; \u0026#34;null\u0026#34;; case Integer i -\u0026gt; String.format(\u0026#34;int %d\u0026#34;, i); case Long l -\u0026gt; String.format(\u0026#34;long %d\u0026#34;, l); case Double d -\u0026gt; String.format(\u0026#34;double %f\u0026#34;, d); case String s -\u0026gt; String.format(\u0026#34;String %s\u0026#34;, s); case Boolean b -\u0026gt; String.format(\u0026#34;Boolean %b\u0026#34;, b); default -\u0026gt; o.toString(); }; } } VirtualThreadè™šæ‹Ÿçº¿ç¨‹ JEP444\nä»€ä¹ˆäº‹è™šæ‹Ÿçº¿ç¨‹ï¼Ÿçœ‹ä¸‹VirtualThreadç±»ä¸Šçš„æ³¨é‡Šã€‚ï¼ˆä¸€å¥è¯å°±æ˜ç™½äº†ï¼‰\nA thread that is scheduled by the Java virtual machine rather than the operating system.\nå¯¹äºå¼€å‘è€…æ¥è¯´è™šæ‹Ÿçº¿ç¨‹åœ¨ä½¿ç”¨ä½“éªŒä¸Šå’Œ Thread å‡ ä¹æ²¡æœ‰åŒºåˆ«ï¼Œä¸ä¹‹å‰çš„ API äº’ç›¸å…¼å®¹ï¼Œä½†æ˜¯ç›¸æ¯”ä¹‹ä¸‹è™šæ‹Ÿçº¿ç¨‹èµ„æºå ç”¨éå¸¸å°‘ã€‚ä¸‹é¢æ¥å¯¹æ¯”ä¸€ä¸‹ä½¿ç”¨ã€‚\nThreadç±»çš„ä½¿ç”¨æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 // åŸå§‹çº¿ç¨‹çš„ä½¿ç”¨ Thread thread = new Thread(() -\u0026gt; { System.out.println(\u0026#34;hello thread\u0026#34;); }, \u0026#34;SystemThread\u0026#34;); thread.start(); // è™šæ‹Ÿçº¿ç¨‹ Thread virtualThread = Thread.ofVirtual().name(\u0026#34;VirtualThread\u0026#34;).unstarted(() -\u0026gt; { System.out.println(\u0026#34;hello virtual thread\u0026#34;); }); virtualThread.start(); Thread.startVirtualThread(() -\u0026gt; { System.out.println(\u0026#34;hello virtual thread, startVirtualThread\u0026#34;); }); ExecutorServiceçº¿ç¨‹æ± ä½¿ç”¨æ–¹å¼\n1 2 3 4 5 6 7 8 9 10 11 // åˆ›å»ºå¹¶æäº¤æ‰§è¡Œè™šæ‹Ÿçº¿ç¨‹ long start = System.currentTimeMillis(); try (var executor = Executors.newVirtualThreadPerTaskExecutor()) { IntStream.range(0, 10_000).forEach(i -\u0026gt; { executor.submit(() -\u0026gt; { Thread.sleep(Duration.ofSeconds(1)); return i; }); }); } System.out.println(\u0026#34;time:\u0026#34; + (System.currentTimeMillis() - start) + \u0026#34;ms\u0026#34;); VirtualThreadæ˜¯ä¸éœ€è¦æ± åŒ–çš„ï¼Œç”¨çš„æ—¶å€™æ–°å»ºå³å¯ã€‚åç»­ä¼šå¯¹è¿™ä¸€å—è¿›ä¸€æ­¥ç ”ç©¶å­¦ä¹ ã€‚ é™„å½• å‚è€ƒ Java 21 æ–°åŠŸèƒ½ä»‹ç» (LTS) å’–å•¡å±‹è§†é¢‘ï¼šé€šå‘Java21-02-Javaè™šæ‹Ÿçº¿ç¨‹ å’–å•¡å±‹è§†é¢‘ï¼šé€šå‘Java21-04-æ–°çš„API å’–å•¡å±‹è§†é¢‘ï¼šé€šå‘Java21-07-å®Œæ•´çš„æ¨¡å¼åŒ¹é…ã€æœ€ç»ˆå›ã€‘ ","date":"2024-04-21T11:33:39+08:00","image":"https://gloryjie.github.io/p/java21%E8%AF%AD%E6%B3%95%E7%89%B9%E6%80%A7/cover_hua0dda0fd1975efc7e10ecc9bbca3e0a7_198222_120x120_fill_q75_box_smart1.jpeg","permalink":"https://gloryjie.github.io/p/java21%E8%AF%AD%E6%B3%95%E7%89%B9%E6%80%A7/","title":"Java21è¯­æ³•ç‰¹æ€§"},{"content":" å°é¢æ˜¯ã€Šæ–—ç½—å¤§é™†2ç»ä¸–å”é—¨ã€‹ä¸­çš„å‡Œè½å®¸ï¼Œç”¨å†°æŠ€èƒ½, å›¾ç‰‡ç”±AIç”Ÿæˆï¼Œå®Œæˆå›¾ç‰‡æ”¾åœ¨é™„å½•ä¸­\nè¯¾ç¨‹é¦–é¡µä»¥åŠå®éªŒè¯´æ˜ç›¸å…³ä»‹ç»é“¾æ¥åœ¨é™„å½•ä¸­ã€‚\nè¯¾ç¨‹ç†è§£ ç®€å•çš„è¯´ï¼Œå°±æ˜¯ç”¨Goæ¥å®ç°ä¸€ä¸ªå•æœºå¤šè¿›ç¨‹ç‰ˆæœ¬çš„MapReduceã€‚(MapReduceè®¡ç®—æ¨¡å‹å¯ä»¥å»æœç´¢ç›¸å…³æ–‡ç« äº†è§£)ã€‚ä¼šæœ‰å¦‚ä¸‹ä¸¤ç§ç±»å‹çš„è¿›ç¨‹\nCoordinatoråè°ƒè€…ï¼šä½œä¸ºä¸€ä¸ªåè°ƒç€ï¼Œåè°ƒMapã€Reduceçš„ä»»åŠ¡äº¤ç»™ä¸åŒçš„Workerå»æ‰§è¡Œï¼Œåè°ƒMapã€Reduceé˜¶æ®µï¼ˆæ‰§è¡Œå®Œæ‰€æœ‰Mapä»»åŠ¡ä¹‹åæ‰å¯ä»¥å»æ‰§è¡ŒReduceä»»åŠ¡ï¼‰ Workeræ‰§è¡Œå™¨ï¼šä»»åŠ¡æ‰§è¡Œè€…ï¼Œæ‰§è¡ŒMapã€Reduceä»»åŠ¡ èµ·æ¥ä¸€ä¸ªMRä»»åŠ¡åï¼Œåªä¼šæœ‰ä¸€ä¸ªCoordinatorè¿›ç¨‹ï¼Œå¯ä»¥æœ‰å¤šä¸ªWorkerè¿›ç¨‹ã€‚éœ€è¦å»è€ƒè™‘å’Œè§£å†³ä¸‹é¢çš„å‡ ä¸ªé—®é¢˜\nCoordinatorå¦‚ä½•æ„ŸçŸ¥workerï¼Ÿ æ‰€æœ‰Mapä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œæ–¹å¯è¿›è¡ŒReduceä»»åŠ¡ï¼ŒCoordinatorå¦‚ä½•è¿›è¡Œåè°ƒåˆ†é…ä»»åŠ¡ï¼Ÿ Mapä»»åŠ¡ä¼šäº§ç”Ÿä¸´æ—¶æ–‡ä»¶ä½œä¸ºè¾“å‡ºï¼Œéœ€è¦æ”¶é›†æ‰€æœ‰çš„ä¸´æ—¶æ–‡ä»¶å†…å®¹ä½œä¸ºReduceçš„è¾“å…¥ï¼Œä¸¤ç§ä»»åŠ¡ä¹‹é—´å¦‚ä½•é…åˆï¼Ÿ Workerå¯èƒ½ä¼šcrashï¼Œæ­£åœ¨å¤„ç†çš„ä»»åŠ¡è¯¥å¦‚ä½•å¤„ç†ï¼Ÿ Workeræ‰§è¡Œä»»åŠ¡æ—¶é—´å¯èƒ½è¿‡é•¿ï¼Œå¦‚ä½•å¤„ç†ï¼Ÿ è¯¾ç¨‹å‰ç½®çŸ¥è¯† 1ã€MapReduceçš„è¿è¡Œæœºåˆ¶\n2ã€Goå†…ç½®çš„RPCé€šä¿¡\n3ã€Goçš„é”ä¿æŠ¤æœºåˆ¶\n4ã€Goæœ¬åœ°çš„å®šæ—¶ä»»åŠ¡time.Ticker ä»»åŠ¡è¿è¡Œæœºåˆ¶ Coordinatorçš„æ‰§è¡Œå…¥å£åœ¨mrcoordinator.goæ–‡ä»¶ä¸­ï¼Œé€»è¾‘å°±æ˜¯åˆ›å»ºä¸€ä¸ªCoordinatorç»“æ„ä½“å®ä¾‹ï¼Œä¹‹åå¾ªç¯æ‰§è¡ŒDone()æ–¹æ³•ï¼Œæ¥åˆ¤æ–­Coordinatoræ˜¯å¦å·²ç»ç»“æŸï¼Œè¿›è€Œåˆ¤æ–­æ•´ä¸ªMRä»»åŠ¡æ˜¯å¦ç»“æŸã€‚\nWorkerçš„æ‰§è¡Œå…¥å£åœ¨mrworker.goæ–‡ä»¶ä¸­ï¼Œé€»è¾‘å°±æ˜¯åŠ è½½Mapã€Reduceçš„å‡½æ•°ï¼Œä¹‹åè°ƒç”¨workerçš„Workeræ–¹æ³•ã€‚å½“å‰Workerè¿›ç¨‹å…·ä½“è¯¥å¦‚ä½•æ‰§è¡ŒMapã€Reduceä»»åŠ¡ï¼Œéœ€è¦è‡ªå·±åœ¨Workeræ–¹æ³•å†…åŒºå®ç°ã€‚\nå®éªŒåªéœ€è¦ä¿®æ”¹src/mré‡Œè¾¹çš„ä¸‰ä¸ªæ–‡ä»¶ï¼Œåœ¨é‡Œè¾¹ä¹¦å†™è‡ªå·±çš„é€»è¾‘ä»£ç \ncoordinator.go worker.go rpc.go å®ç°è®¾è®¡ è¿™é‡Œå…ˆæ˜ç¡®ä¸€ä¸‹æ¦‚å¿µï¼Œå¯¹å¯åŠ¨ä¸€ä¸ªMRä»»åŠ¡ç§°ä¹‹ä¸ºJobï¼Œè€ŒMapä»»åŠ¡ã€Reduceä»»åŠ¡ç§°ä¸ºTaskã€‚åé¢éƒ½ç”¨è‹±æ–‡æ¥è¡¨ç¤ºã€‚ Coordinatorçš„è®¾è®¡ ä¸€ä¸ªCoordinatoréœ€è¦çŸ¥é“MR Jobå½“å‰éœ€è¦å¤„ç†çš„filesï¼Œå¹¶ä¸”æœ‰éœ€è¦å‡ ä¸ªReduceï¼ˆæ‰§è¡ŒMakeCoordinatorï¿½çš„æ—¶å€™ä¼šä¼ å…¥ï¼‰ã€‚\nç”±äºä¸€ä¸ªjobä¼šå­˜åœ¨mapã€Reduceé˜¶æ®µï¼Œè¿™é‡Œç»™jobè®¾è®¡äº†å‡ ä¸ªé˜¶æ®µï¼ˆçŠ¶æ€ï¼‰ï¼Œç”¨æ•´å‹æ¥è¡¨ç¤ºã€‚å¦‚ä¸‹\né˜¶æ®µ é˜¶æ®µå€¼ åˆå§‹é˜¶æ®µ 1 Mapé˜¶æ®µ 2 Reduceé˜¶æ®µ 3 ç­‰å¾…Workerä¸‹çº¿é˜¶æ®µ 4 jobç»“æŸ 5 Coordinatoréœ€è¦çŸ¥é“å½“å‰æœ‰å“ªäº›Workerå­˜åœ¨ï¼Œåˆ¤æ–­å…¶Workerçš„å­˜æ´»ï¼Œè¿›è€Œåˆ¤æ–­ä»»åŠ¡æ˜¯å¦è¿˜åœ¨ç»§ç»­æ‰§è¡Œã€‚æ‰€ä»¥éœ€è¦ç”¨ä¸€ä¸ªç»“æ„ä½“æ¥è¡¨æ˜¯workerèŠ‚ç‚¹ï¼Œåˆ¤æ–­å­˜æ´»çš„ä¾æ®ç®€å•çš„å¿ƒè·³å¤„ç†ã€‚\nCoordinatoréœ€è¦æ¨è¿›mapã€reduceä»»åŠ¡çš„æ‰§è¡Œï¼Œéœ€è¦ç»´æŠ¤taskåˆ—è¡¨ã€‚ï¼ˆå…·ä½“taskçš„è®¾è®¡çœ‹ä¸‹é¢ï¼‰è¿™é‡Œåˆ†åˆ«ä¸ºä¸¤ç§ç±»å‹çš„taskè®¾ç«‹ä¸¤ä¸ªåˆ—è¡¨ï¼Œä½¿ç”¨mapå­˜æ”¾ã€‚\nå› ä¸ºæ‰§è¡Œå®Œmapä»»åŠ¡åï¼Œæ‰å¯ä»¥æ‰§è¡Œreduceä»»åŠ¡ï¼Œè¿™é‡Œç®€å•èµ·è§ï¼Œåˆ¤æ–­å„ä¸ªé˜¶æ®µä»»åŠ¡å®Œæˆçš„æ ‡è®°ä½¿ç”¨è®¡æ•°æ¥è¡¨ç¤ºã€‚æ‰€ä»¥è€Œå¤–éœ€è¦ä¸¤ä¸ªç»Ÿè®¡æ•°å€¼ï¼šmapä»»åŠ¡å®Œæˆæ•°é‡ã€reduceä»»åŠ¡å®Œæˆæ•°é‡ã€‚\nå¤šä¸ªWorkerè¯·æ±‚ï¼Œéœ€è¦å¹¶å‘ä¿®æ”¹taskç»“æ„ä½“çš„çŠ¶æ€ä»¥åŠç»Ÿè®¡ä»»åŠ¡æ•°ç­‰ï¼Œä¼šéœ€è¦äº’æ–¥è®¿é—®ï¼Œè¿˜éœ€è¦ä¸€ä¸ªmutexè¿›è¡Œæ•°æ®ä¿æŠ¤ã€‚\næ€»ç»“ä¸Šè¿°ï¼Œä¸€ä¸ªCoordinatorå†…åŒ…å«çš„ç»“æ„å¦‚ä¸‹ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 type Coordinator struct { // Your definitions here. files []string reduceNum int jobStage int workerNodeMap map[int]*workerNode mapTaskMap map[int]*TaskResult reduceTaskMap map[int]*TaskResult mapTaskDoneCount int reduceTaskDoneCount int taskMutex sync.Mutex } type workerNode struct { workerId int lastHeartBeatTime int64 } const JOB_STAGE_INIT = 1 const JOB_MAP_STAGE = 2 const JOB_REDUCE_STAGE = 3 const JOB_END = 5 const MAP_TASK = \u0026#34;map\u0026#34; const REDUCE_TASK = \u0026#34;reduce\u0026#34; Taskçš„è®¾è®¡ mapTaskã€reduceTaskéƒ½æœ‰å¾ˆå¤§çš„ç›¸ä¼¼æ€§ï¼Œå¤–å‡ºæ¥çœ‹éƒ½æ˜¯è¾“å…¥ã€è¾“å‡ºã€‚æ‰€ä»¥è¿™é‡Œè®¾è®¡éƒ½ä½¿ç”¨åŒä¸€ä¸ªç»“æ„ä½“æ¥è¡¨ç¤ºä¸¤ç§é˜¶æ®µçš„ä»»åŠ¡ã€‚ä½¿ç”¨ä¸€ä¸ªtypeå­—æ®µè¿›è¡ŒåŒºåˆ†å³å¯ã€‚è¿™é‡Œä¹Ÿç»™taskè¿›è¡Œäº†çŠ¶æ€çš„åˆ’åˆ†ã€‚ï¼ˆè¿™é‡Œå‡è®¾taskæ²¡æœ‰å¤±è´¥çš„å¯èƒ½ï¼‰ã€‚\né˜¶æ®µ é˜¶æ®µå€¼ å¾…æ‰§è¡Œ 1 æ‰§è¡Œä¸­ 2 æ‰§è¡Œå®Œæˆ 3 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 const TASK_PENDING = 1 const TASK_EXECUTING = 2 const TASK_COMPLETED = 3 type TaskResult struct { TaskId int // ç”±Coordinatorè¿›è¡Œåˆ†é… TaskType string // map or reduce Status int FilePath []string // input file path ResultPath []string // output file path ExecuteSuccess bool // execute result WorkerId int // execute worker NReduce int StartExecuteTime int64 } type HeartbeatResult struct { WorkerId int Shutdown bool // å½“trueæ—¶ç›´æ¥é€€å‡ºè¿›ç¨‹ } Workerçš„è®¾è®¡ workeræ¯”è¾ƒç®€å•ï¼Œä¸»è¦æ˜¯å’ŒCoordinatorè¿›è¡Œé€šä¿¡ï¼Œæ‰§è¡Œmapã€reduceä»»åŠ¡ã€‚\nç”±äºmapã€reduceç±»å‹çš„taskéƒ½æ˜¯workeræ‰§è¡Œï¼Œä¸­é—´æ–‡ä»¶çš„å¤„ç†ä¹Ÿè½åˆ°äº†workerèº«ä¸Šã€‚ä¸‹é¢æ˜¯å¤„ç†å„ä¸ªé˜¶æ®µçš„é€»è¾‘\nmapé˜¶æ®µï¼šworkerä¼šæ ¹æ®reduceçš„æ•°é‡nï¼Œåˆ›å»ºnä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œå¹¶å°†mapäº§ç”Ÿçš„kvç»“æœï¼Œåˆ†æ•£å†™å…¥åˆ°è¿™nä¸ªä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ä¹‹åï¼Œå°†è¿™nä¸ªä¸´æ—¶æ–‡ä»¶è·¯å¾„ä½œä¸ºå½“å‰mapä»»åŠ¡çš„ResultPathï¼Œä¸ŠæŠ¥ç»™Coordinatorã€‚ Coordinatoråè°ƒé˜¶æ®µï¼šå°†mapäº§å‡ºçš„ä¸´æ—¶æ–‡ä»¶ï¼Œå†™å…¥åˆ°å¯¹åº”çš„Reduceä»»åŠ¡çš„FilePathä¸­ä½œä¸ºè¾“å…¥ reduceé˜¶æ®µï¼šworkerè¯»å–æ‰€æœ‰FilePathä¸­çš„æ–‡ä»¶åï¼Œåšä¸€ä¸ªsortã€mergeï¼Œæ‰§è¡ŒReduceå‡½æ•°ã€‚å°†äº§å‡ºå†™å…¥åˆ°mr-out-taskIdçš„æ–‡ä»¶ä¸­ï¼ˆè¿™é‡Œç®€å•èµ·è§ï¼Œä¸å†™å…¥tmp fileäº†ï¼‰ è¿™é‡Œå’Œå®éªŒæ¨èçš„ä¸€æ ·ï¼Œå°†mapç”Ÿæˆçš„ä¸­é—´KVæ•°æ®ä½œä¸ºjsonç»“æ„å†™å…¥åˆ°ä¸´æ—¶æ–‡ä»¶ä¸­ã€‚ RPCé€šä¿¡è®¾è®¡ Coordinatorå’Œworkerä¹‹é—´ï¼Œæ˜¯é‡‡ç”¨ä¸æ–­è¯·æ±‚çš„æ¨¡å¼ï¼ˆpullï¼‰ã€‚Coordinatorä¸ä¼šä¸»åŠ¨ç»™workerå‘é€æ•°æ®ã€‚\nè¿™é‡Œè®¾è®¡äº†ä¸‰ç§çš„æ¥å£äº¤äº’\nworkerå®šæ—¶ä¸ŠæŠ¥å¿ƒè·³ç»™Coordinator workerä¸æ–­åœ°ä»Coordinatorä¸­è·å–ä»»åŠ¡æ‰§è¡Œ workeræ‰§è¡Œå®Œä¸€ä¸ªä»»åŠ¡åï¼Œä¸ŠæŠ¥æ‰§è¡Œç»“æœç»™Coordinator åŸºæœ¬å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š\nè¾ƒé‡è¦çš„å®šæ—¶ä»»åŠ¡ å®šæ—¶ä»»åŠ¡ä¸»è¦æ˜¯è§£å†³Workerè·å–åˆ°ä»»åŠ¡åï¼Œä½†æ˜¯Workerå®•æœºçš„æƒ…å†µï¼Œè¿™æ—¶å€™Workeræ‰§è¡Œçš„taskéœ€è¦äº¤ç»™å…¶ä»–Workerå»æ‰§è¡Œã€‚\nè®¾è®¡ä¸Šï¼Œé€šè¿‡åˆ¤å®šWorkerçš„å¿ƒè·³è¶…æ—¶æ—¶é—´æ¥åˆ¤å®šWorkeræ˜¯å¦å®•æœºï¼Œä»¥åŠæŒ‰ç…§å®éªŒé¦–é¡µè¯´çš„ï¼Œç®€å•çš„åˆ¤æ–­å¦‚æœtaskæ‰§è¡Œæ—¶é—´è¶…è¿‡äº†10sï¼Œä¹Ÿè®¤ä¸ºè¯¥ä»»åŠ¡éœ€è¦åˆ‡æ¢Workeræ‰§è¡Œã€‚\nä¸‹é¢æ˜¯Coordinatorçš„ä¸¤ä¸ªå®šæ—¶ä»»åŠ¡é€»è¾‘\næ‰«æWorkeråˆ—è¡¨ï¼Œå¦‚æœä¸Šä¸€æ¬¡å¿ƒè·³æ—¶é—´è¶…è¿‡äº†é¢„å®šçš„è¶…æ—¶æ—¶é—´ï¼Œé‚£ä¹ˆå°±ä»Workeråˆ—è¡¨ä¸­å‰”é™¤ æ‰«ætaskåˆ—è¡¨ï¼Œä»»åŠ¡å¤„äºæ­£åœ¨æ‰§è¡Œä¸­ï¼Œå¦‚æœå…¶æ‰§è¡Œçš„Workerå¹¶ä¸åœ¨Workerçš„åˆ—è¡¨ä¸­ï¼Œæˆ–è€…æ‰§è¡Œæ—¶é—´è¶…è¿‡äº†10sï¼Œåˆ™é‡ç½®è¯¥ä»»åŠ¡ä¸ºå¾…æ‰§è¡ŒçŠ¶æ€ è¿™æ ·å°±å¯ä»¥é‡ç½®Taskçš„çŠ¶æ€ï¼Œå­˜æ´»çš„Workerå°±å¯ä»¥è·å–å¾—åˆ°Taskæ‰§è¡Œã€‚\nCoordinatoræ‰§è¡Œé˜¶æ®µæ¨è¿› åœ¨æ‰§è¡Œå®Œæ‰€æœ‰çš„Mapä»»åŠ¡ä¹‹åï¼Œæ‰å¯ä»¥æ‰§è¡ŒReduceä»»åŠ¡ã€‚è®¾è®¡ä¸Šï¼Œå°†ä»»åŠ¡æ¨è¿›æ”¾åˆ°äº†Coordinatorä¸­æ¥å—ä»»åŠ¡æ‰§è¡Œç»“æœçš„é€»è¾‘ä¸­ã€‚å¦‚æœæ‰€æœ‰çš„Mapä»»åŠ¡æ‰§è¡Œå®Œæˆäº†ï¼Œé‚£ä¹ˆå°±å°†JOB_STAGEä¿®æ”¹æˆReduceé˜¶æ®µï¼Œè¿™æ ·Workerå°±å¯ä»¥è·å–åˆ°Reduceä»»åŠ¡å»æ‰§è¡Œã€‚\nåªæœ‰CoordinatorçŸ¥é“æ•´ä½“çš„å®Œæˆæƒ…å†µï¼Œä½†æ˜¯Workerä¸çŸ¥é“ã€‚Workerå¯ä»¥ç®€å•çš„è®¾è®¡ä¸ºå¦‚æœRPCè°ƒç”¨å¤±è´¥ï¼Œå°±è®¤ä¸ºCoordinatorç»“æŸäº†ï¼Œè‡ªå·±ä¹Ÿè·Ÿç€é€€å‡ºã€‚æˆ–è€…æœ‰æŸç§RPCç»“æœèƒ½è®©WorkerçŸ¥é“å½“å‰éœ€è¦é€€å‡ºã€‚\nè¿™é‡Œè®¾è®¡é€šè¿‡Workerçš„å¿ƒè·³è¿”å›ç»“æœæ¥å‘ŠçŸ¥Workerä¸‹ä¸€æ­¥çš„æ‰§è¡Œï¼Œå¦‚æœæ”¶åˆ°shutdownå‘½ä»¤ï¼Œé‚£ä¹ˆå°±ç›´æ¥é€€å‡ºã€‚Coordinatoråœ¨Reduceé˜¶æ®µç»“æŸï¼Œå°±ç›´æ¥èµ°åˆ°endé˜¶æ®µã€‚\nè¸©å‘ å¯¹äºgoè¯­è¨€ä¸å¤ªç†Ÿç»ƒï¼Œä¸€äº›å¸¸è§çš„å‘è¸©äº†ä¸å°‘\nåˆ‡ç‰‡sliceã€å“ˆå¸Œè¡¨mapçš„éå†ä¿®æ”¹ã€åˆ é™¤å…ƒç´  goå†…ç½®rpcä½¿ç”¨ï¼Œå¯¹äºé»˜è®¤å€¼æ˜¯å¦‚ä½•å¤„ç†çš„ï¼ˆè¿™é‡Œå¯¹äºå„ç§çŠ¶æ€ï¼Œå»ºè®®é¿å¼€é»˜è®¤å€¼ï¼‰ è¿™é‡Œæœ‰ä¸ªå‘è°ƒè¯•äº†å¾ˆä¹…ï¼Œå°±æ˜¯workeråœ¨å»è¯·æ±‚ä»»åŠ¡çš„æ—¶å€™ï¼Œåˆ›å»ºçš„TaskResultç»“æ„ä½“æ˜¯æ”¾åœ¨äº†forå¾ªç¯å¤–è¾¹ï¼Œå¯¼è‡´åœ¨å¯¼è‡´æ¯æ¬¡è°ƒç”¨è·å–åˆ°çš„ç»“æœä¼šæºæ‚äº†ä¸Šæ¬¡è°ƒç”¨çš„ç»“æœğŸ˜­ï¼Œè¿˜æœ‰é»˜è®¤å€¼ä¸ä¿®æ”¹çš„é—®é¢˜ã€‚\nä¸‹é¢æ”¾ç‚¹ä»£ç ç¤ºä¾‹\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 func getTaskFromCoordinator(workerId int) TaskResult { // é—®é¢˜å°±åœ¨è¿™é‡Œï¼Œåªåˆ›å»ºäº†ä¸€æ¬¡ï¼Œå†…éƒ¨forå¾ªç¯ä¼šå…±ç”¨ä¸€ä¸ªå®ä¾‹ï¼Œå¤šæ¬¡è¯·æ±‚å’Œæºæ‚ä¸Šä¸€æ¬¡è¯·æ±‚çš„ç»“æœ // result := \u0026amp;TaskResult{} for { // æ­£ç¡®åº”è¯¥æ”¾åœ¨å¾ªç¯é‡Œè¾¹ result := \u0026amp;TaskResult{} ok := call(\u0026#34;Coordinator.GetTaskToExecute\u0026#34;, \u0026amp;workerId, result) if ok { if result.TaskId \u0026gt; -1 { return *result } time.Sleep(time.Second * 2) } else { log.Fatal(\u0026#34;è·å–ä»»åŠ¡å¤±è´¥\u0026#34;) } } } å¯¼è‡´çš„ç»“æœå°±æ˜¯å¦‚ä¸‹ï¼Œæ˜æ˜Coordinatorè¿”å›çš„taskIdæ˜¯0ï¼Œä¸ºå•¥workeræ”¶åˆ°çš„taskIdæ˜¯-1ï¼Ÿï¼Ÿï¼Ÿ\nåŸå› å°±æ˜¯ä¸Šä¸€æ¬¡è¯·æ±‚çš„ç»“æœè¿”å›çš„å°±æ˜¯-1ï¼Œè¿™ä¸€æ¬¡è¿”å›çš„æ˜¯0ï¼Œæ˜¯ä¸ªé»˜è®¤å€¼ï¼Œgoçš„rpcæ˜¯ä¸ä¼šä¼ è¾“ï¼Œä¹Ÿå°±æ˜¯ä¸ä¼šå»ä¿®æ”¹-1ï¼ŒçœŸæ˜¯æ—¥äº†ç‹—ã€‚æ‰€ä»¥è¿™é‡Œå»ºè®®å¯¹äºå„ç§çŠ¶æ€ã€idå€¼çš„å®šä¹‰ä¸è¦ä½¿ç”¨é»˜è®¤å€¼ï¼ï¼ï¼\næ€»ç»“ è¿™é‡Œæ˜¯å‡è®¾æ‰€æœ‰çš„Taskæœ€ç»ˆåœ¨10så†…éƒ½æ˜¯ä¼šæ‰§è¡Œå®Œæˆçš„ï¼Œ10sæœªå®Œæˆåˆ™äº¤ç»™åˆ«çš„Workerå»æ‰§è¡Œã€‚å®é™…ä¸Šï¼ŒTaskçš„æ‰§è¡Œæ˜¯ä¼šå‡ºç°å„ç§å„æ ·çš„æƒ…å†µçš„ã€‚è€Œä¸”ï¼Œè¿™é‡Œè®¾è®¡ä¸Šæ¯ä¸€ä¸ªè¾“å…¥çš„fileä½œä¸ºä¸€ä¸ªMapä»»åŠ¡ï¼Œä¼šå‡ºç°è®¡ç®—å€¾æ–œçš„æƒ…å†µã€‚ç†æƒ³æƒ…å†µä¸‹éœ€è¦å¹³å‡çš„è¿›è¡Œåˆ‡åˆ†æ•°æ®ï¼Œè®©æ¯ä¸ªMapä»»åŠ¡å°½å¯èƒ½çš„å¤„ç†ç›¸åŒå¤§å°çš„æ•°æ®ã€‚\né¦–æ¬¡æ¥è§¦goè¯­è¨€æ¥å†™é¡¹ç›®ï¼Œä¸ä¼šçš„å°±è¾¹æœç´¢åˆ«å†™ï¼Œæ•ˆç‡åæ…¢äº›ï¼ŒdebugåŠå¤©ã€‚ä¸è¿‡ä¸»è¦æ˜¯è¦åœ¨å…³é”®èŠ‚ç‚¹è¾“å‡ºè¯¦ç»†çš„æ—¥å¿—ä¿¡æ¯ï¼Œä¾¿äºè§‚å¯Ÿå„ç§æ•°æ®ç»“æ„çš„å…·ä½“å˜æ›´æƒ…å†µã€‚\né™„å½• è¯¾ç¨‹é¦–é¡µï¼šhttps://pdos.csail.mit.edu/6.824/index.html\nè¯¾ç¨‹å®éªŒè¯´æ˜ï¼šhttps://pdos.csail.mit.edu/6.824/labs/lab-mr.html\nå‚è€ƒ ","date":"2024-03-24T21:37:07+08:00","image":"https://gloryjie.github.io/p/mit6824_lab1/cover_hu4faae92f089e584f7c8e1fb189bc7c34_1938005_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/mit6824_lab1/","title":"MIT6824å®éªŒ1-MapReduceè®¾è®¡"},{"content":" å°é¢å£çº¸ä¸ºå›½æ¼«ã€Šä»™é€†ã€‹çš„å¥³ä¸» ææ…•å©‰\nå°„çº¿æ³•ç®€ä»‹ å°„çº¿æ³•çš„åŸºæœ¬æ€æƒ³æ˜¯é‡ç›®æ ‡ç‚¹å‘ä¸€ä¸ªæ–¹å‘å¼•å‡ºä¸€æ¡æ— é™çš„å°„çº¿æ³•ï¼Œç»Ÿè®¡å°„çº¿ä¸å¤šè¾¹å½¢çš„è¾¹ç›¸äº¤çš„æ•°é‡\nå¦‚æœæ˜¯å¶æ•°ï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å¤– å¦‚æœæ˜¯å¥‡æ•°ï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†… ä¸€èˆ¬å°„çº¿çš„æ–¹å‘æ˜¯xè½´çš„æ­£æ•°æ–¹å‘ã€‚ç®—æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸ºO(n)ï¼Œnä¸ºå¤šè¾¹å½¢çš„è¾¹ï¼ˆç‚¹ï¼‰æ•°ã€‚\næƒ…å†µåˆ—ä¸¾å’Œåˆ†äº« ä¸‹é¢å‡ ç§æƒ…å†µéƒ½ç®—æ˜¯ç‚¹åœ¨å¤šè¾¹å½¢å†…\nç‚¹åœ¨å¤šè¾¹å½¢å†… ç‚¹å’Œå¤šè¾¹å½¢çš„é¡¶ç‚¹é‡å  ç‚¹åœ¨å¤šè¾¹å½¢çš„è¾¹ä¸Š å°„çº¿æ³•å°†åˆ¤æ–­åœ¨å¤šè¾¹å½¢å†…ï¼Œè½¬ç§»ä¸ºåˆ¤æ–­ç‚¹å’Œè¾¹çš„å…³ç³»ã€‚æ‰€ä»¥ç®—æ³•çš„ä¸»è¦é€»è¾‘ï¼Œå°±æ˜¯åœ¨åˆ¤æ–­ç‚¹å°„çº¿å’Œè¾¹çš„ç©ºé—´å…³ç³»ã€‚æœ‰ä¸¤ç§æƒ…å†µéœ€è¦ç‰¹æ®Šå¤„ç†ã€‚\nå°„çº¿ç»è¿‡è¾¹çš„é¡¶ç‚¹ åˆ¤æ–­ç‚¹åœ¨æ–œçº¿çš„å·¦ä¾§çš„ä¸‰è§’å‡½æ•° ä»ç‚¹å¼•å‡ºçš„å°„çº¿å’Œå¤šè¾¹å½¢çš„è¾¹æœ‰ä¸‹é¢å‡ ç§æƒ…å†µéœ€è¦è€ƒè™‘\nç‚¹åœ¨åœ¨è¾¹çš„ä¸Šæ–¹ã€ä¸‹æ–¹ã€å³ä¾§ï¼Œä¸ä¼šç›¸äº¤ è¾¹æ°´å¹³çš„æƒ…å†µï¼Œä¸åˆ¤æ–­äº¤ç‚¹æ•°ï¼Œåªåˆ¤æ–­æ˜¯å¦åœ¨çº¿ä¸Š å°„çº¿ç»è¿‡è¾¹çš„é¡¶ç‚¹ï¼Œåˆ™éœ€è¦ä½¿ç”¨æƒé‡å€¼æ¥è§£å†³ç»è¿‡é¡¶ç‚¹çš„é—®é¢˜ï¼ˆæ¶µç›–äº†è¾¹å‚ç›´çš„æƒ…å†µï¼‰ Bç‚¹åœ¨Aç‚¹çš„ä¸‹æ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼-0.5 Bç‚¹åœ¨Aç‚¹çš„ä¸Šæ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼+0.5 è¾¹å‚ç›´çš„æƒ…å†µ ç‚¹åœ¨å‚ç›´çš„è¾¹Pä¸Šï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†… ç‚¹åœ¨åœ¨å‚ç›´çš„è¾¹çš„å·¦è¾¹ï¼Œåˆ™ç‚¹ä¸è¯¥è¾¹å¿…ç„¶æœ‰äº¤ç‚¹ è¾¹æ–œçº¿çš„æƒ…å†µ ç‚¹åœ¨çº¿çš„å·¦è¾¹ï¼Œè‚¯å®šä¼šæœ‰äº¤ç‚¹ é€šè¿‡ä¸‰è§’å‡½æ•°æ¥åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨è¾¹çš„å·¦è¾¹ å„ç§æƒ…å†µçš„åˆ¤æ–­ä»£ç  ç‚¹çš„è¡¨è¾¾\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 @Data @AllArgsConstructor @NoArgsConstructor public class Point { /** * ç»åº¦ */ private Double lng; /** * çº¬åº¦ */ private Double lat; } ç›®æ ‡ç‚¹å’Œå¤šè¾¹å½¢çš„é¡¶ç‚¹é‡åˆ\n1 2 3 4 5 6 // é¡¶ç‚¹é‡åˆçš„æƒ…å†µ for (Point polygonPoint : polygonPoints) { if (Objects.equals(target, polygonPoint)) { return true; } } ç‚¹åœ¨çš„ä¸Šæ–¹ã€ä¸‹æ–¹ã€å³ä¾§ï¼Œå°„çº¿è‚¯å®šä¸ä¼šå’Œè¾¹ç›¸äº¤\n1 2 3 4 if (target.getLat() \u0026lt; minLat || target.getLat() \u0026gt; maxLat || target.getLng() \u0026gt; maxLng) { pointA = pointB; continue; } è¾¹æ°´å¹³çš„æƒ…å†µ,è‹¥ç‚¹åœ¨æ°´å¹³çš„è¾¹ä¸Šï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†…ã€‚å¹³è¡Œé‡å çš„æƒ…å†µï¼Œä¸åšäº¤ç‚¹æ•°åˆ¤æ–­ã€‚\n1 2 3 4 5 6 7 if (Objects.equals(pointA.getLat(), pointB.getLat())) { if (target.getLng() \u0026lt;= maxLng \u0026amp;\u0026amp; target.getLng() \u0026gt;= minLng) { return true; } pointA = pointB; continue; } å°„çº¿ç»è¿‡è¾¹çš„é¡¶ç‚¹(æ­¤æ—¶è¾¹å¯èƒ½å‚ç›´)ï¼Œè§£å†³æ–¹æ¡ˆä¸ºï¼šå¦‚æœäº¤ç‚¹æ˜¯å¾…æµ‹å¤šè¾¹å½¢æŸä¸ªè¾¹ä¸Šçš„ä¸€ä¸ªé¡¶ç‚¹ï¼Œåˆ™åªæœ‰å½“è¯¥è¾¹çš„å¦ä¸€ä¸ªé¡¶ç‚¹ä½äºå°„çº¿ä¸‹æ–¹æ—¶ï¼Œäº¤ç‚¹æ‰ç®—åœ¨å†…ã€‚è¿™å®é™…ä¸Šç­‰åŒäºå°†ä¸å°„çº¿ç›¸äº¤çš„é¡¶ç‚¹è§†ä¸ºç•¥é«˜äºå°„çº¿ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 if ((Objects.equals(target.getLat(), pointA.getLat()) \u0026amp;\u0026amp; target.getLng() \u0026lt; pointA.getLng()) || Objects.equals(target.getLat(), pointB.getLat()) \u0026amp;\u0026amp; target.getLng() \u0026lt; pointB.getLng()) { if (pointB.getLat() \u0026lt; pointA.getLat()) { // Bç‚¹åœ¨Aç‚¹çš„ä¸‹æ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼-0.5 intersectPointWeights -= 0.5; } else if (pointB.getLat() \u0026gt; pointA.getLat()) { // Bç‚¹åœ¨Aç‚¹çš„ä¸Šæ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼+0.5 intersectPointWeights += 0.5; } pointA = pointB; continue; } è¾¹å‚ç›´çš„æƒ…å†µ\n1 2 3 4 5 6 7 8 9 10 11 12 if (Objects.equals(pointA.getLng(), pointB.getLng())) { if (Objects.equals(target.getLng(), pointA.getLng())) { // è‹¥ç‚¹åœ¨å‚ç›´çš„è¾¹Pä¸Šï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†… return true; } else if (target.getLng() \u0026lt; pointA.getLng()) { // è‹¥ç‚¹åœ¨åœ¨å‚ç›´çš„è¾¹çš„å·¦è¾¹ï¼Œåˆ™ç‚¹ä¸è¯¥è¾¹å¿…ç„¶æœ‰äº¤ç‚¹ intersectPointCount++; } pointA = pointB; continue; } è¾¹æ–œçº¿çš„æƒ…å†µï¼Œä½¿ç”¨ä¸‰è§’å‡½æ•°æ¥åˆ¤æ–­\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 if (target.getLng() \u0026lt;= minLng) { // ç‚¹pointçš„xåæ ‡åœ¨è¾¹çš„å·¦ä¾§ï¼Œé‚£ä¹ˆè‚¯å®šç›¸äº¤ intersectPointCount++; } else if (target.getLng() \u0026lt; maxLng) { // ç‚¹pointçš„xåæ ‡åœ¨ç‚¹Bã€Açš„xåæ ‡ä¸­é—´ double diff = (target.getLat() - pointA.getLat()) * (pointA.getLng() - pointB.getLng()) / (pointA.getLat() - pointB.getLat()) + pointA.getLng() - target.getLng(); if (diff \u0026gt;= 0) { if (diff \u0026lt; PRECISION) { // ç”±äºdoubleç²¾åº¦åœ¨è®¡ç®—æ—¶ä¼šæœ‰æŸå¤±ï¼Œæ•…åŒ¹é…ä¸€å®šçš„å®¹å·® // ç‚¹åœ¨æ–œçº¿P1P2ä¸Š return true; } else { // ç‚¹å‘å³å°„çº¿ä¸æ–œçº¿P1P2æœ‰äº¤ç‚¹ intersectPointCount++; } } } æµ‹è¯•ç¤ºä¾‹ å›¾å½¢å¦‚ä¸‹\nç‚¹é›†åˆï¼Œä¹Ÿå°±æ˜¯å¤šè¾¹å½¢\n1 [{\u0026#34;lng\u0026#34;:110.269889,\u0026#34;lat\u0026#34;:21.308982},{\u0026#34;lng\u0026#34;:110.277883,\u0026#34;lat\u0026#34;:21.231378},{\u0026#34;lng\u0026#34;:110.275219,\u0026#34;lat\u0026#34;:21.178585},{\u0026#34;lng\u0026#34;:110.309195,\u0026#34;lat\u0026#34;:21.166692},{\u0026#34;lng\u0026#34;:110.345361,\u0026#34;lat\u0026#34;:21.166692},{\u0026#34;lng\u0026#34;:110.345361,\u0026#34;lat\u0026#34;:21.225846},{\u0026#34;lng\u0026#34;:110.37871,\u0026#34;lat\u0026#34;:21.218632},{\u0026#34;lng\u0026#34;:110.416809,\u0026#34;lat\u0026#34;:21.210863},{\u0026#34;lng\u0026#34;:110.41919,\u0026#34;lat\u0026#34;:21.224181},{\u0026#34;lng\u0026#34;:110.419648,\u0026#34;lat\u0026#34;:21.234822},{\u0026#34;lng\u0026#34;:110.385148,\u0026#34;lat\u0026#34;:21.282747},{\u0026#34;lng\u0026#34;:110.351299,\u0026#34;lat\u0026#34;:21.286387},{\u0026#34;lng\u0026#34;:110.269889,\u0026#34;lat\u0026#34;:21.308982}] æµ‹è¯•ä»£ç \n1 2 3 4 5 6 7 8 9 10 11 12 13 14 System.out.println(\u0026#34;å›¾å½¢å¤–ï¼Œå°„çº¿å’Œçº¿æ°´å¹³ï¼Œä¸åœ¨çº¿ä¸Šï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.301195,21.166692), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å†…, å°„çº¿å’Œçº¿æ°´å¹³ï¼Œåœ¨çº¿ä¸Šï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.319195,21.166692), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å†…ï¼Œå°„çº¿å’Œçº¿å‚ç›´ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.319195,21.186692), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å¤–ï¼Œå°„çº¿å’Œçº¿å‚ç›´ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.219195,21.186692), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å†…ï¼Œç»è¿‡çº¿é¡¶ç‚¹ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.305361,21.225846), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å¤–ï¼Œç»è¿‡çº¿é¡¶ç‚¹ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.245361,21.225846), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å†…ï¼Œå’Œä¸€æ¡æ–œçº¿ç›¸äº¤ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.305361,21.265846), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å¤–ï¼Œå’Œä¸€æ¡æ–œçº¿ç›¸äº¤ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.245361,21.265846), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å†…ï¼Œå’Œå¤šæ¡çº¿ç›¸äº¤ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.305361,21.221846), polygonPointList)); System.out.println(\u0026#34;å›¾å½¢å¤–ï¼Œå’Œå¤šæ¡çº¿ç›¸äº¤ï¼š\u0026#34; + RayCastUtil.isPointInPolygon(new Point(110.245361,21.221846), polygonPointList)); å®Œæ•´ä»£ç  1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44 45 46 47 48 49 50 51 52 53 54 55 56 57 58 59 60 61 62 63 64 65 66 67 68 69 70 71 72 73 74 75 76 77 78 79 80 81 82 83 84 85 86 87 88 89 90 91 92 93 94 95 96 97 98 99 100 101 102 103 public class RayCastUtil { private static final double PRECISION = 2e-10; public static boolean isPointInPolygon(Point target, List\u0026lt;Point\u0026gt; polygonPoints) { // è¿™é‡Œä¸éœ€è¦é¦–å°¾ç›¸è¿ï¼Œæœ‰äº›ä¸éœ€è¦ï¼Œè¿™å°± if (Objects.equals(polygonPoints.get(0), polygonPoints.get(polygonPoints.size() - 1))) { polygonPoints = polygonPoints.subList(0, polygonPoints.size() - 1); } // é¡¶ç‚¹é‡åˆçš„æƒ…å†µ for (Point polygonPoint : polygonPoints) { if (Objects.equals(target, polygonPoint)) { return true; } } // Xè½´å°„çº¿ä¸å¤šè¾¹å½¢çš„äº¤ç‚¹æ•° int intersectPointCount = 0; // Xè½´å°„çº¿ä¸å¤šè¾¹å½¢é¡¶ç‚¹ç›¸äº¤çš„æƒå€¼ double intersectPointWeights = 0; // pointA -\u0026gt; pointB ä»£è¡¨ä¸€æ¡è¾¹ Point pointA = polygonPoints.get(0); Point pointB = null; final int pointSize = polygonPoints.size(); for (int i = 1; i \u0026lt;= pointSize; i++) { // forä¸­å®šä¹‰\u0026lt;=ä»¥åŠè¿™é‡Œçš„%å–ä½™ï¼Œæ˜¯ä¸ºäº†å…³æ³¨æœ€åä¸€ä¸ªèŠ‚ç‚¹è¿æ¥é¦–èŠ‚ç‚¹è¿™æ¡è¾¹çš„æƒ…å†µ pointB = polygonPoints.get(i % pointSize); double minLat = Math.min(pointA.getLat(), pointB.getLat()); double maxLat = Math.max(pointA.getLat(), pointB.getLat()); double minLng = Math.min(pointA.getLng(), pointB.getLng()); double maxLng = Math.max(pointA.getLng(), pointB.getLng()); // ç›®æ ‡ç‚¹åœ¨çš„ä¸Šæ–¹ã€ä¸‹æ–¹ã€å³ä¾§ï¼Œé‚£ä¹ˆå°±ä¸ä¼šç›¸äº¤ if (target.getLat() \u0026lt; minLat || target.getLat() \u0026gt; maxLat || target.getLng() \u0026gt; maxLng) { pointA = pointB; continue; } // è¾¹æ°´å¹³çš„æƒ…å†µ,è‹¥ç‚¹åœ¨æ°´å¹³çš„è¾¹ä¸Šï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†…, if (Objects.equals(pointA.getLat(), pointB.getLat())) { if (target.getLng() \u0026lt;= maxLng \u0026amp;\u0026amp; target.getLng() \u0026gt;= minLng) { return true; } pointA = pointB; continue; } // è¾¹ç•Œå¤„ç†ï¼šå°„çº¿ç»è¿‡è¾¹çš„é¡¶ç‚¹(æ­¤æ—¶è¾¹å¯èƒ½å‚ç›´) if ((Objects.equals(target.getLat(), pointA.getLat()) \u0026amp;\u0026amp; target.getLng() \u0026lt; pointA.getLng()) || Objects.equals(target.getLat(), pointB.getLat()) \u0026amp;\u0026amp; target.getLng() \u0026lt; pointB.getLng()) { if (pointB.getLat() \u0026lt; pointA.getLat()) { // Bç‚¹åœ¨Aç‚¹çš„ä¸‹æ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼-0.5 intersectPointWeights -= 0.5; } else if (pointB.getLat() \u0026gt; pointA.getLat()) { // Bç‚¹åœ¨Aç‚¹çš„ä¸Šæ–¹ï¼Œé‚£ä¹ˆæƒé‡å€¼+0.5 intersectPointWeights += 0.5; } pointA = pointB; continue; } // è¾¹å‚ç›´çš„æƒ…å†µ if (Objects.equals(pointA.getLng(), pointB.getLng())) { if (Objects.equals(target.getLng(), pointA.getLng())) { // è‹¥ç‚¹åœ¨å‚ç›´çš„è¾¹Pä¸Šï¼Œåˆ™ç‚¹åœ¨å¤šè¾¹å½¢å†… return true; } else if (target.getLng() \u0026lt; pointA.getLng()) { // è‹¥ç‚¹åœ¨åœ¨å‚ç›´çš„è¾¹çš„å·¦è¾¹ï¼Œåˆ™ç‚¹ä¸è¯¥è¾¹å¿…ç„¶æœ‰äº¤ç‚¹ intersectPointCount++; } pointA = pointB; continue; } // è¾¹æ–œçš„æƒ…å†µ if (target.getLng() \u0026lt;= minLng) { // ç‚¹pointçš„xåæ ‡åœ¨è¾¹çš„å·¦ä¾§ï¼Œé‚£ä¹ˆè‚¯å®šç›¸äº¤ intersectPointCount++; } else if (target.getLng() \u0026lt; maxLng) { // ç‚¹pointçš„xåæ ‡åœ¨ç‚¹Bã€Açš„xåæ ‡ä¸­é—´ double diff = (target.getLat() - pointA.getLat()) * (pointA.getLng() - pointB.getLng()) / (pointA.getLat() - pointB.getLat()) + pointA.getLng() - target.getLng(); if (diff \u0026gt;= 0) { if (diff \u0026lt; PRECISION) { // ç”±äºdoubleç²¾åº¦åœ¨è®¡ç®—æ—¶ä¼šæœ‰æŸå¤±ï¼Œæ•…åŒ¹é…ä¸€å®šçš„å®¹å·® // ç‚¹åœ¨æ–œçº¿P1P2ä¸Š return true; } else { // ç‚¹å‘å³å°„çº¿ä¸æ–œçº¿P1P2æœ‰äº¤ç‚¹ intersectPointCount++; } } } pointA = pointB; } return (intersectPointCount + Math.abs(intersectPointWeights)) % 2 != 0; } } é™„å½• å‚è€ƒ YouTubeè§†é¢‘ï¼šChecking if a point is inside a polygon is RIDICULOUSLY simple (Ray casting algorithm) - Inside code\nåˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…çš„Pythonå®ç°åŠå°åº”ç”¨ï¼ˆå°„çº¿æ³•ï¼‰\nç»´åŸºç™¾ç§‘ï¼šå¤šè¾¹å½¢å†…çš„ç‚¹\n","date":"2024-03-04T20:33:08+08:00","image":"https://gloryjie.github.io/p/%E5%B0%84%E7%BA%BF%E6%B3%95-%E5%88%A4%E6%96%AD%E7%82%B9%E6%98%AF%E5%90%A6%E5%9C%A8%E5%A4%9A%E8%BE%B9%E5%BD%A2%E5%86%85/cover_hue2c682d0e4643ecbc5c998a202920083_1132640_120x120_fill_q75_box_smart1.jpeg","permalink":"https://gloryjie.github.io/p/%E5%B0%84%E7%BA%BF%E6%B3%95-%E5%88%A4%E6%96%AD%E7%82%B9%E6%98%AF%E5%90%A6%E5%9C%A8%E5%A4%9A%E8%BE%B9%E5%BD%A2%E5%86%85/","title":"å°„çº¿æ³• åˆ¤æ–­ç‚¹æ˜¯å¦åœ¨å¤šè¾¹å½¢å†…"},{"content":" 1 å°é¢æ˜¯ã€Šæ­»äº¡ææµ…ã€‹æ¸¸æˆä¸­çš„ ç›ç› å®˜æ–¹æœ‰æ•™ç¨‹ï¼šhttps://resilience4j.readme.io/v1.7.0/docs/getting-started-3\nè¿™é‡Œåšä¸ªç®€å•ä½¿ç”¨è®°å½•ã€‚ ç‰ˆæœ¬è¦æ±‚ Resilience4jç‰ˆæœ¬ JDKç‰ˆæœ¬ 1.7 8 2.0 17 è¿™é‡Œç”¨çš„jdk8ï¼Œä½¿ç”¨Resilience4jçš„1.7ç‰ˆæœ¬ã€‚mvnä¾èµ–å¦‚ä¸‹\n1 2 3 4 5 \u0026lt;dependency\u0026gt; \u0026lt;groupId\u0026gt;io.github.resilience4j\u0026lt;/groupId\u0026gt; \u0026lt;artifactId\u0026gt;resilience4j-spring-boot2\u0026lt;/artifactId\u0026gt; \u0026lt;version\u0026gt;1.7.1\u0026lt;/version\u0026gt; \u0026lt;/dependency\u0026gt; è¿™ä¸ªåŒ…æŠŠResilience4jçš„åŸºæœ¬ç»„ä»¶éƒ½å¼•å…¥è¿›æ¥äº†ã€‚\nymlé…ç½® é…ç½®å¯ä»¥æœ‰ä¸‰ä¸ªå±‚çº§çš„é…ç½®ï¼Œåˆ†åˆ«å¯ä»¥ç»§æ‰¿ã€‚\nä¿®æ”¹é»˜è®¤é…ç½® è‡ªå®šä¹‰å¯å…±äº«çš„é…ç½® å®ä¾‹è‡ªå®šä¹‰é…ç½® 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 resilience4j.circuitbreaker: # æŒ‡å®šå¯¹åº”çš„ç»„ä»¶ configs: default: # ä¿®æ”¹é»˜è®¤é…ç½® slidingWindowSize: 100 permittedNumberOfCallsInHalfOpenState: 10 waitDurationInOpenState: 10000 failureRateThreshold: 60 eventConsumerBufferSize: 10 registerHealthIndicator: true someShared: # å¯å…±äº«çš„é…ç½® slidingWindowSize: 50 permittedNumberOfCallsInHalfOpenState: 10 instances: # ä¸‹é¢æ˜¯å®ä¾‹è‡ªå®šä¹‰é…ç½® backendA: # å®ä¾‹åç§° baseConfig: default # æŒ‡å®šç»§æ‰¿çš„é…ç½® waitDurationInOpenState: 5000 backendB: baseConfig: someShared äº‹ä»¶ç›‘å¬å™¨ Resilience4jæä¾›äº†ä¸¤ç§ç»†ç²’åº¦çš„æ—¶é—´ç›‘å¬\nRegistryç»„ä»¶çš„å¢ã€åˆ ã€æ›¿æ¢äº‹ä»¶ ç»„ä»¶å®ä¾‹çš„çŠ¶æ€å˜åŒ–äº‹ä»¶ Resilience4jåŸç”Ÿä½¿ç”¨æ—¶åœ¨å¯¹åº”ç»„ä»¶å®ä¾‹çš„åŸºç¡€ä¸Šå»è¿›è¡Œè®¾ç½®ç›‘å¬ï¼Œä½†æ˜¯ç»“åˆSpringBootä¹‹åæ˜¯æ²¡æœ‰åŠæ³•ç›´æ¥æ‹¿åˆ°å¯¹åº”çš„ç»„ä»¶å®ä¾‹ã€‚å¯ä»¥é€šè¿‡ç›‘å¬å®ä¾‹çš„å¢ã€åˆ ã€æ›¿æ¢çš„åŠ¨ä½œï¼Œè¿›è€Œæ‹¿åˆ°å¯¹åº”çš„å®ä¾‹ï¼Œä¹‹åå†è¿›è¡Œç›‘å¬å®ä¾‹çŠ¶æ€çš„å˜æ›´ã€‚\nè‡ªå·±åˆ›å»ºçš„RegistryEventConsumerçš„Beanï¼Œä¼šè‡ªåŠ¨æ·»åŠ åˆ°SpringBootè‡ªèº«ç®¡ç†çš„CircuitBreakerRegistryä¸­ã€‚\nä»¥ç›‘å¬CircuitBreakerç»„ä»¶ä¸ºä¾‹ï¼Œå‚è€ƒä»£ç å¦‚ä¸‹ï¼ˆIMessageServiceä¸ºè‡ªå·±çš„beanï¼‰\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 @Bean public RegistryEventConsumer\u0026lt;CircuitBreaker\u0026gt; circuitBreakerEventConsumer(IMessageService messageService){ return new RegistryEventConsumer\u0026lt;CircuitBreaker\u0026gt;() { @Override public void onEntryAddedEvent(EntryAddedEvent\u0026lt;CircuitBreaker\u0026gt; entryAddedEvent) { entryAddedEvent.getAddedEntry().getEventPublisher().onStateTransition(event -\u0026gt; { String circuitBreakerName = event.getCircuitBreakerName(); CircuitBreaker.State fromState = event.getStateTransition().getFromState(); CircuitBreaker.State toState = event.getStateTransition().getToState(); log.info(\u0026#34;CircuitBreaker \u0026#39;{}\u0026#39; changed state from {} to {}\u0026#34;, circuitBreakerName, fromState, toState); StringBuilder builder = new StringBuilder(); builder.append(\u0026#34;\u0026lt;font color=\\\u0026#34;warning\\\u0026#34;\u0026gt;æ–­è·¯å™¨çŠ¶æ€å‘ç”Ÿå˜åŒ– \u0026#34;).append(DateUtil.now()).append(\u0026#34; \u0026lt;/font\u0026gt;\\n\u0026#34;); builder.append(\u0026#34;\u0026gt; æ–­è·¯å™¨åç§°ï¼š\u0026#34;).append(circuitBreakerName).append(\u0026#34;\\n\u0026#34;); builder.append(\u0026#34;\u0026gt; å˜åŒ–å‰çŠ¶æ€ï¼š\u0026#34;).append(fromState).append(\u0026#34;\\n\u0026#34;); builder.append(\u0026#34;\u0026gt; å˜åŒ–åçŠ¶æ€ï¼š\u0026#34;).append(toState).append(\u0026#34;\\n\u0026#34;); builder.append(\u0026#34;è¯·å°½å¿«å¤„ç†ï¼ï¼ï¼\u0026#34;); messageService.reportDefaultMsg(builder.toString()); }); } @Override public void onEntryRemovedEvent(EntryRemovedEvent\u0026lt;CircuitBreaker\u0026gt; entryRemoveEvent) { } @Override public void onEntryReplacedEvent(EntryReplacedEvent\u0026lt;CircuitBreaker\u0026gt; entryReplacedEvent) { } }; } ä½¿ç”¨å½¢å¼ æ³¨è§£ä½¿ç”¨ åªéœ€è¦åœ¨å¯¹åº”çš„æ–¹æ³•åŠ ä¸Šå¯¹åº”ç»„ä»¶çš„ç›´æ¥å³å¯ã€‚è¿˜å¯ä»¥åœ¨æ·»åŠ é™çº§å¤„ç†çš„æ–¹ï¼Œä¼šè‡ªåŠ¨æ ¹æ®å¼‚å¸¸ç±»å‹è¿›è¡Œæ‰¹é‡ã€‚\n1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 @CircuitBreaker(name = BACKEND, fallbackMethod = \u0026#34;fallback\u0026#34;) @RateLimiter(name = BACKEND) @Bulkhead(name = BACKEND, fallbackMethod = \u0026#34;fallback\u0026#34;) @Retry(name = BACKEND) @TimeLimiter(name = BACKEND) public Mono\u0026lt;String\u0026gt; method(String param1) { return Mono.error(new NumberFormatException()); } private Mono\u0026lt;String\u0026gt; fallback(String param1, CallNotPermittedException e) { return Mono.just(\u0026#34;Handled the exception when the CircuitBreaker is open\u0026#34;); } private Mono\u0026lt;String\u0026gt; fallback(String param1, BulkheadFullException e) { return Mono.just(\u0026#34;Handled the exception when the Bulkhead is full\u0026#34;); } private Mono\u0026lt;String\u0026gt; fallback(String param1, NumberFormatException e) { return Mono.just(\u0026#34;Handled the NumberFormatException\u0026#34;); } // å…¶å®ä¹Ÿå¯ä»¥å†™ä¸€ä¸ªé€šç”¨çš„ï¼Œå†…éƒ¨if elseå¥½äº†ï¼Œå‡å°‘æ–¹æ³•çš„æ•°é‡ private Mono\u0026lt;String\u0026gt; fallback(String param1, Exception e) { return Mono.just(\u0026#34;Handled any other exception\u0026#34;); } ä»£ç ä½¿ç”¨ æ³¨è§£éƒ½æ˜¯åŸºäºAOPå»å¤„ç†çš„ï¼Œé€šç—…å°±æ˜¯è°ƒç”¨å†…éƒ¨æ–¹æ³•çš„æ—¶å€™æ˜¯ä¸ä¼šç”Ÿæ•ˆçš„ã€‚å¯ä»¥æ‰‹åŠ¨è·å–åˆ°å¯¹åº”çš„å®åŠ›ã€‚\n1 2 3 4 5 @Resource private CircuitBreakerRegistry circuitBreakerRegistry; // ä»registryè·å–å®ä¾‹ï¼Œå’Œæ³¨è§£ä½¿ç”¨çš„æ˜¯åŒä¸€ä¸ªå®ä¾‹ circuitBreakerRegistry.circuitBreaker(\u0026#34;tencentAddressService\u0026#34;); starterçš„é…ç½®è¿‡ç¨‹ ç»“åˆSpringBootçš„starterï¼Œæµç¨‹åŸºæœ¬å°±æ˜¯è¯»å–é…ç½®ï¼Œåˆ›å»ºå„ç§Beanç»„ä»¶ã€‚æä¾›äº†å„ç§æ³¨è§£ï¼Œåˆ™è¿‡ç¨‹å°±æ˜¯åŸºäºAopå»å®ç°çš„ã€‚è¿™é‡Œç®€å•çœ‹ä¸‹CircuitBreakerçš„å®ç°è¿‡ç¨‹ã€‚\nåŸºæœ¬æ¶‰åŠä¸¤ä¸ªç±»\nCircuitBreakerConfigurationé…ç½®ç±»ï¼Œè´Ÿè´£å¯åŠ¨æ—¶åˆ›å»ºæ–­è·¯å™¨ç›¸å…³çš„Bean CircuitBreakerAspectåˆ‡é¢å¤„ç†ï¼ŒCircuitBreakeræ³¨è§£çš„å¤„ç† Beançš„ç”Ÿæˆ ä¸¤ä¸ªå…³é”®çš„Bean\nCircuitBreakerRegistry CircuitBreakerAspect 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Bean @Primary public RegistryEventConsumer\u0026lt;CircuitBreaker\u0026gt; circuitBreakerRegistryEventConsumer( Optional\u0026lt;List\u0026lt;RegistryEventConsumer\u0026lt;CircuitBreaker\u0026gt;\u0026gt;\u0026gt; optionalRegistryEventConsumers) { // è‡ªå®šä¹‰çš„RegistryEventConsumerä¼šæ³¨å…¥è¿›æ¥ return new CompositeRegistryEventConsumer\u0026lt;\u0026gt;( optionalRegistryEventConsumers.orElseGet(ArrayList::new)); } @Bean public CircuitBreakerRegistry circuitBreakerRegistry( EventConsumerRegistry\u0026lt;CircuitBreakerEvent\u0026gt; eventConsumerRegistry, RegistryEventConsumer\u0026lt;CircuitBreaker\u0026gt; circuitBreakerRegistryEventConsumer, @Qualifier(\u0026#34;compositeCircuitBreakerCustomizer\u0026#34;) CompositeCustomizer\u0026lt;CircuitBreakerConfigCustomizer\u0026gt; compositeCircuitBreakerCustomizer) { CircuitBreakerRegistry circuitBreakerRegistry = createCircuitBreakerRegistry( circuitBreakerProperties, circuitBreakerRegistryEventConsumer, compositeCircuitBreakerCustomizer); registerEventConsumer(circuitBreakerRegistry, eventConsumerRegistry); // then pass the map here initCircuitBreakerRegistry(circuitBreakerRegistry, compositeCircuitBreakerCustomizer); return circuitBreakerRegistry; } @Bean @Conditional(value = {AspectJOnClasspathCondition.class}) public CircuitBreakerAspect circuitBreakerAspect( CircuitBreakerRegistry circuitBreakerRegistry, @Autowired(required = false) List\u0026lt;CircuitBreakerAspectExt\u0026gt; circuitBreakerAspectExtList, FallbackDecorators fallbackDecorators, SpelResolver spelResolver ) { return new CircuitBreakerAspect(circuitBreakerProperties, circuitBreakerRegistry, circuitBreakerAspectExtList, fallbackDecorators, spelResolver); } åˆ‡é¢å¤„ç†é€»è¾‘ åˆ‡é¢çš„é€»è¾‘æ¯”è¾ƒç®€å•\nçœ‹çœ‹æœ‰æ²¡æœ‰æ³¨è§£ circuitBreakerRegistryä¸­è·å–CircuitBreakerå®ä¾‹ æ˜¯å¦ä½¿ç”¨fallbackï¼Œä¸åŒçš„å¤„ç† 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 @Pointcut(value = \u0026#34;@within(circuitBreaker) || @annotation(circuitBreaker)\u0026#34;, argNames = \u0026#34;circuitBreaker\u0026#34;) public void matchAnnotatedClassOrMethod(CircuitBreaker circuitBreaker) { } @Around(value = \u0026#34;matchAnnotatedClassOrMethod(circuitBreakerAnnotation)\u0026#34;, argNames = \u0026#34;proceedingJoinPoint, circuitBreakerAnnotation\u0026#34;) public Object circuitBreakerAroundAdvice(ProceedingJoinPoint proceedingJoinPoint, @Nullable CircuitBreaker circuitBreakerAnnotation) throws Throwable { // æ–¹æ³•ä¸Šæœ‰æ²¡æœ‰æ³¨è§£ Method method = ((MethodSignature) proceedingJoinPoint.getSignature()).getMethod(); String methodName = method.getDeclaringClass().getName() + \u0026#34;#\u0026#34; + method.getName(); if (circuitBreakerAnnotation == null) { circuitBreakerAnnotation = getCircuitBreakerAnnotation(proceedingJoinPoint); } if (circuitBreakerAnnotation == null) { //because annotations wasn\u0026#39;t found return proceedingJoinPoint.proceed(); } // spelç›¸å…³çš„ String backend = spelResolver.resolve(method, proceedingJoinPoint.getArgs(), circuitBreakerAnnotation.name()); io.github.resilience4j.circuitbreaker.CircuitBreaker circuitBreaker = getOrCreateCircuitBreaker( methodName, backend); Class\u0026lt;?\u0026gt; returnType = method.getReturnType(); String fallbackMethodValue = spelResolver.resolve(method, proceedingJoinPoint.getArgs(), circuitBreakerAnnotation.fallbackMethod()); // æ²¡æœ‰fallback if (StringUtils.isEmpty(fallbackMethodValue)) { return proceed(proceedingJoinPoint, methodName, circuitBreaker, returnType); } // æœ‰fallback FallbackMethod fallbackMethod = FallbackMethod .create(fallbackMethodValue, method, proceedingJoinPoint.getArgs(), proceedingJoinPoint.getTarget()); return fallbackDecorators.decorate(fallbackMethod, () -\u0026gt; proceed(proceedingJoinPoint, methodName, circuitBreaker, returnType)).apply(); } é™„å½• å‚è€ƒ å®˜æ–¹æ•™ç¨‹ How to configure to events in Resilience4j Spring starter ","date":"2024-02-02T11:18:46+08:00","image":"https://gloryjie.github.io/p/resilience4j-%E6%95%B4%E5%90%88springboot/cover_hu3163765b57fc9a9b6b4dbc88ef7da476_2717844_120x120_fill_q75_box_smart1.jpg","permalink":"https://gloryjie.github.io/p/resilience4j-%E6%95%B4%E5%90%88springboot/","title":"Resilience4j-æ•´åˆSpringboot"},{"content":" äº¤å‹ï¼šæ‰©å……åœˆå­ï¼Œå¤šè®¤è¯†å¦¹å­ï¼Œå¤šèŠ±æ—¶é—´è¿›è¡Œçº¿ä¸Šäº¤æµï¼›èˆå¾—èŠ±é’±æ‰“æ‰® é˜…è¯»ï¼šéæŠ€æœ¯ä¹¦ç±20+æœ¬ï¼ŒæŠ€æœ¯ä¹¦ç±10+ï¼Œç½‘æ–‡1æœ¬ è¿åŠ¨ï¼šè·µè¡Œå¹²å‡€å¢è‚Œï¼Œ8ä¸ªæœˆå¢è‚Œã€3ä¸ªæœˆå‡è„‚ï¼Œç›®æ ‡65kg æ¸¸æˆï¼šæ‰“å®Œ5+æ¸¸æˆï¼Œæ­»äº¡ææµ…ã€åªç‹¼ã€è‰¾å°”ç™»æ³•ç¯ã€ffe7ç­‰ æŠ€æœ¯æå‡ï¼šåŸºç¡€å¢å¼ºï¼ˆç½‘ç»œã€æ“ä½œç³»ç»Ÿï¼‰ã€ç®—æ³•LCåˆ·é¢˜100é“ã€æ¥è§¦AIGC æŠ€æœ¯è¯¾ç¨‹ï¼šè‡³å°‘ä¸€é—¨å›½å¤–è¯¾ç¨‹ï¼ˆçœ‹å®Œå¹¶åšå®Œå®éªŒï¼‰ï¼Œä¾‹å¦‚MIT6.824ã€MIT6.S081 é¡¹ç›®å®è·µï¼šè®¾è®¡ä¸€ä¸ªä¸ªäººé¡¹ç›®å¹¶ä¸Šçº¿è¿è¡Œ æŠ•èµ„ç†è´¢ï¼šç»§ç»­å­¦ä¹ ç›¸å…³çŸ¥è¯†ï¼Œåœ¨å°½å¯èƒ½ä¸å¢åŠ èµ„é‡‘çš„æƒ…å†µä¸‹ï¼Œå›æœ¬ï¼ ç”Ÿæ´»ä½“éªŒï¼šå‡ºè¡Œæ¸¸ç©ï¼Œå¦‚æ­¦åŠŸå±±ã€æ­¦æ±‰ã€ä¹å¯¨æ²Ÿ æ–°æŠ€èƒ½ï¼šæ‰‹æœºæ‘„å½±\u0026amp;å‰ªè¾‘ ä¹ æƒ¯å…»æˆç›®æ ‡\n12ç‚¹å‰å…¥ç¡ï¼Œ7ç‚¹èµ· è¡Œè·¯ä¸­ï¼Œä¸ç©æ‰‹æœº æ¯å‘¨è¿›è¡Œæ€»ç»“ æ¯æœˆ1~2æœ¬ä¹¦ é™ä½æ‹–å»¶ç—‡ ","date":"2024-01-04T17:47:55+08:00","image":"https://gloryjie.github.io/p/2024%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/cover_hu6b62954a64c9532f0495ca1fd21ae92d_130115_120x120_fill_box_smart1_3.png","permalink":"https://gloryjie.github.io/p/2024%E5%B9%B4%E5%BA%A6%E8%AE%A1%E5%88%92/","title":"2024å¹´åº¦è®¡åˆ’"}]